# Story 2.4: Implement Screen Recording

## Status
Done

## Story
**As a** user,
**I want** to record my computer screen (full screen or a specific window),
**so that** I can capture software demonstrations or presentations.

## Acceptance Criteria
1. User can initiate screen recording from the application [FR7].
2. User can choose between recording the full screen or selecting a specific application window [FR7].
3. Recording includes system audio (if technically feasible and configured).
4. User can stop the recording [FR11].
5. The resulting video file is saved and added to the media library/timeline [FR12].

## Tasks / Subtasks
- [x] Task 1: Create Recording Service in Main Process (AC: 1, 2, 4, 5)
  - [x] Create RecordingService class in apps/electron/src/services/recordingService.ts
  - [x] Implement getScreenSources() using Electron's desktopCapturer API
  - [x] Implement startScreenRecording(source: 'fullscreen' | 'window', windowId?: string)
  - [x] Implement stopRecording() to finalize and save video file
  - [x] Use MediaRecorder API or FFmpeg to capture and encode video
  - [x] Save recordings to ~/.clipforge/recordings/ directory
  - [x] Generate unique filename with timestamp
  - [x] Handle recording state (idle, recording, stopped)
- [x] Task 2: Implement Screen Source Selection UI (AC: 2)
  - [x] Create RecordingDialog component in apps/renderer/src/components/recording/
  - [x] Fetch available screen sources via IPC
  - [x] Display list of available screens/windows
  - [x] Allow user to select full screen or specific window
  - [x] Show preview thumbnail of selected source (if available)
  - [x] Handle user selection and pass to recording service
- [x] Task 3: Add IPC Handlers for Recording (AC: 1, 2, 4, 5)
  - [x] Add 'get-screen-sources' IPC handler
  - [x] Add 'start-screen-recording' IPC handler
  - [x] Add 'stop-recording' IPC handler
  - [x] Add 'recording-started' IPC event
  - [x] Add 'recording-stopped' IPC event with file path
  - [x] Add 'recording-error' IPC event
  - [x] Update preload.ts to expose recording methods
  - [x] Update electron.d.ts with recording API types
- [x] Task 4: Implement Recording Controls UI (AC: 1, 4)
  - [x] Create RecordingControls component
  - [x] Add "Start Recording" button/menu item
  - [x] Add "Stop Recording" button (enabled during recording)
  - [x] Show recording indicator/status (red dot, timer)
  - [x] Display recording duration timer
  - [x] Handle start/stop recording actions
  - [x] Disable relevant UI elements during recording
- [x] Task 5: Implement MediaRecorder Integration (AC: 1, 2, 3, 4, 5)
  - [x] Use Electron's getDisplayMedia() or desktopCapturer API
  - [x] Get MediaStream from selected screen source
  - [x] Create MediaRecorder instance with video/audio tracks
  - [x] Configure codec (prefer VP8/VP9 or H.264 for webm/mp4)
  - [x] Handle recording chunks and accumulate data
  - [x] Finalize recording file on stop
  - [x] Handle system audio capture (if available)
  - [x] Error handling for permissions and API failures
- [x] Task 6: Handle System Audio Capture (AC: 3)
  - [x] Check system audio capture availability
  - [x] Request audio permissions if needed
  - [x] Include audio track in MediaStream (if supported)
  - [x] Handle cases where system audio is not available
  - [x] Fallback gracefully without system audio
  - [x] Document platform limitations (macOS/Windows)
- [x] Task 7: Auto-Import Recorded Video (AC: 5)
  - [x] On recording stop, automatically import recorded file
  - [x] Use existing importVideo functionality
  - [x] Add recorded clip to media library
  - [x] Optionally add to timeline (user preference)
  - [x] Show success notification
  - [x] Handle import errors gracefully
- [x] Task 8: Add Recording Permissions Handling (AC: 1, 2)
  - [x] Request screen recording permissions on macOS
  - [x] Handle permission denied scenarios
  - [x] Show helpful error messages for permission issues
  - [x] Guide users to system preferences if needed
  - [x] Check permissions before showing source selector

## Dev Notes

### Previous Story Insights
From Story 2.1: Video import functionality exists. ImportDialog and fileService handle file imports. IPC handlers process imports and add clips to media library.

From Story 1.2: FileService already handles video file operations and thumbnail generation. Media library displays imported clips.

**Current State**: No recording functionality exists yet. This is new functionality requiring Electron's native recording APIs.

### Data Models
**Recording State** [Source: architecture.md#data-models]:
- No new data models required for MVP
- Recording is ephemeral - creates VideoClip after recording completes
- Recording settings can be stored in UI state (preferences)
- Recorded files stored as VideoClip instances (same as imported files)

**Recording Configuration** (temporary UI state):
```typescript
interface RecordingState {
  isRecording: boolean;
  recordingStartTime: number | null;
  selectedSource: ScreenSource | null;
  outputPath: string | null;
}
```

### API Specifications
**IPC Commands** [Source: architecture.md#api-specification]:
```typescript
// New IPC commands
'get-screen-sources': () => Promise<ScreenSource[]>;
'start-screen-recording': { 
  source: 'fullscreen' | 'window'; 
  windowId?: string;
  includeAudio?: boolean;
} => Promise<void>;
'stop-recording': () => Promise<{ filePath: string }>;

// IPC events (main â†’ renderer)
'recording-started': { success: boolean };
'recording-stopped': { filePath: string };
'recording-error': { error: string };
'recording-progress': { duration: number }; // Optional
```

**Screen Source Type**:
```typescript
interface ScreenSource {
  id: string;
  name: string;
  thumbnail: string | null; // Base64 data URL
  type: 'screen' | 'window';
}
```

**Electron Service API** [Source: architecture.md#frontend-architecture]:
```typescript
// New electronService methods
getScreenSources(): Promise<ScreenSource[]>;
startScreenRecording(options: {
  source: 'fullscreen' | 'window';
  windowId?: string;
  includeAudio?: boolean;
}): Promise<void>;
stopRecording(): Promise<string>; // Returns file path
```

### Component Specifications
**RecordingDialog Component** [Source: architecture.md#components]:
- Modal dialog for selecting recording source
- Display list of available screens/windows
- Show preview thumbnails for sources
- Allow selection of full screen or specific window
- Include audio capture option checkbox
- Cancel and Start Recording buttons

**RecordingControls Component** [Source: architecture.md#components]:
- Button to open recording dialog or start recording
- Stop recording button (enabled during recording)
- Recording indicator (red dot, pulsing)
- Recording duration timer display
- Status message area

**RecordingService (Main Process)** [Source: architecture.md#components]:
- Use Electron's desktopCapturer.getSources()
- Use MediaStream and MediaRecorder for recording
- Handle file writing and finalization
- Manage recording state
- Handle errors and cleanup

### File Locations
**New Files**:
- `apps/electron/src/services/recordingService.ts` - Recording service implementation
- `apps/renderer/src/components/recording/RecordingDialog.tsx` - Source selection dialog
- `apps/renderer/src/components/recording/RecordingControls.tsx` - Recording UI controls

**Modified Files**:
- `apps/electron/src/handlers/ipcHandlers.ts` - Add recording IPC handlers
- `apps/electron/src/main.ts` - Register recording service
- `apps/electron/src/preload.ts` - Expose recording API
- `apps/renderer/src/services/electronService.ts` - Add recording methods
- `apps/renderer/src/types/electron.d.ts` - Add recording type definitions
- `apps/renderer/src/components/media/MediaLibrary.tsx` - Show recording button
- `apps/renderer/src/App.tsx` - Integrate recording controls

### Testing Requirements
**Testing Standards** [Source: architecture.md#tech-stack]:
- Manual testing for MVP
- Test file location: apps/electron/tests/
- Test cases: Screen source selection, recording start/stop, file saving, import
- Performance: Recording should not cause UI freezing

**Key Test Cases**:
- Click "Start Recording" opens source selection dialog
- Dialog displays available screens and windows
- Selecting full screen starts recording correctly
- Selecting specific window starts recording correctly
- Recording indicator appears during recording
- Recording duration timer increments correctly
- Stop recording button stops recording and saves file
- Recorded file is saved to ~/.clipforge/recordings/
- Recorded file is automatically imported after recording
- Recorded clip appears in media library
- System audio is included (if available and enabled)
- Recording works without system audio (graceful fallback)
- Permission denied shows helpful error message
- Multiple recordings create separate files
- Recording doesn't crash or freeze UI
- Stop button disabled when not recording
- Cannot start multiple recordings simultaneously

### Technical Constraints
**Electron APIs** [Source: architecture.md#tech-stack]:
- Use `desktopCapturer.getSources()` for screen source list
- Use `navigator.mediaDevices.getDisplayMedia()` or Electron's desktopCapturer for stream
- MediaRecorder API for encoding (webm format)
- File System API for saving recorded files
- Consider using FFmpeg for format conversion if needed

**Platform Considerations** [Source: architecture.md#development-workflow]:
- **macOS**: Requires screen recording permissions in System Preferences
- **Windows**: Screen capture typically works without special permissions
- **Linux**: May require additional setup depending on distribution
- System audio capture has platform-specific limitations
- macOS system audio capture requires additional permissions

**MediaRecorder Limitations** [Source: architecture.md#coding-standards]:
- Codec support varies by platform and browser
- WebM is most widely supported format
- May need FFmpeg post-processing for MP4 conversion
- Quality and bitrate settings may vary by platform
- Frame rate depends on source and platform capabilities

**Recording Performance** [Source: architecture.md#performance-optimization]:
- Recording should not block main process
- Use worker threads if available for encoding
- Optimize file writing to prevent disk I/O blocking
- Limit recording duration warnings (optional)
- Handle memory constraints for long recordings

**File Management** [Source: architecture.md#coding-standards]:
- Save recordings to `~/.clipforge/recordings/` directory
- Generate unique filenames with timestamps
- Use format: `screen-recording-YYYY-MM-DD-HHmmss.webm` (or mp4)
- Clean up failed recordings on error
- Handle disk space issues gracefully

**Error Handling** [Source: architecture.md#coding-standards]:
- Handle permission denied errors
- Handle source unavailable errors
- Handle MediaRecorder initialization failures
- Handle file write errors
- Handle stream disconnection errors
- Show user-friendly error messages
- Clean up resources on error

**State Management** [Source: architecture.md#frontend-architecture]:
- Track recording state in UI store (isRecording, duration)
- Handle recording start/stop state transitions
- Update UI immediately on state changes
- Persist recording preferences (optional)

## Testing

### Testing Standards
- **Test Approach**: Manual testing for MVP
- **Test Location**: apps/electron/tests/ and apps/renderer/tests/
- **Test Framework**: Manual verification only
- **Key Test Cases**:
  - Start recording button opens source selection dialog
  - Source dialog shows available screens and windows
  - Selecting full screen starts recording
  - Selecting window starts recording correctly
  - Recording indicator appears and shows duration
  - Stop recording saves file successfully
  - Recorded file is in recordings directory
  - Recorded file is automatically imported
  - Recorded clip appears in media library
  - System audio is captured (if available)
  - Recording works without system audio
  - Permission errors show helpful messages
  - Cannot start recording while another is active
  - Stop button is disabled when not recording
  - Recording doesn't freeze UI
  - Multiple recordings create separate files
  - File format is correct and playable

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master Bob |
| 2025-10-29 | 1.1 | Implementation completed - screen recording functionality with source selection, MediaRecorder integration, and auto-import | Developer James |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
No blocking issues encountered. Implementation proceeded smoothly with all components integrated successfully.

### Completion Notes List
1. **Recording Service Created**: Implemented RecordingService in main process with screen source enumeration, recording start/stop, and file management
2. **IPC Handlers Added**: Added complete IPC communication layer for recording operations including event handling
3. **UI Components Implemented**: Created RecordingDialog for source selection and RecordingControls for recording management with timer display
4. **MediaRecorder Integration**: Integrated browser MediaRecorder API with Electron's desktopCapturer for screen capture with VP9/VP8 codec support
5. **Auto-Import Functionality**: Recorded videos are automatically imported to media library after recording stops
6. **Error Handling**: Comprehensive error handling with user-friendly messages for permissions and recording failures
7. **Audio Support**: Optional system audio capture with graceful fallback when unavailable (disabled by default due to platform complexity)
8. **Permission Handling**: Screen recording permissions are requested with helpful error messages guiding users
9. **WebM Duration Fix**: Implemented FFmpeg re-muxing to fix duration metadata issue with browser-generated WebM files (MediaRecorder doesn't write duration properly)
10. **UI Polish**: Fixed z-index to ensure recording dialog appears above timeline playhead and other UI elements

### File List
**New Files:**
- `apps/electron/src/services/recordingService.ts` - Main process recording service with screen source management
- `apps/renderer/src/components/recording/RecordingDialog.tsx` - UI for selecting screen/window to record with thumbnails
- `apps/renderer/src/components/recording/RecordingControls.tsx` - Recording controls with timer and status display

**Modified Files:**
- `apps/electron/src/handlers/ipcHandlers.ts` - Added IPC handlers for recording operations
- `apps/electron/src/preload.ts` - Exposed recording API to renderer process
- `apps/electron/src/services/ffmpegService.ts` - Added fixWebMDuration() method for WebM duration metadata fix
- `apps/renderer/src/types/electron.d.ts` - Added TypeScript definitions for recording API including ScreenSource interface
- `apps/renderer/src/services/electronService.ts` - Added recording service methods and event listeners
- `apps/renderer/src/App.tsx` - Integrated RecordingControls component with auto-import handler
- `apps/renderer/src/components/timeline/TimelineClip.tsx` - Fixed pre-existing unused variable warnings
- `packages/shared/src/types.ts` - Recording types already defined (RecordingEvents, RecordingCommands)

## QA Results
*Results from QA Agent review will be populated here*

