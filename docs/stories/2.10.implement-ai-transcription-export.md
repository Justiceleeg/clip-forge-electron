# Story 2.10: Implement AI Transcription Export

## Status
Done

## Story
**As a** user,
**I want** the option to generate an AI-powered transcription of my exported video's audio and save it to a separate file,
**so that** I can easily create captions, subtitles, or transcripts for accessibility and content creation purposes.

## Acceptance Criteria
1. An optional "Include Transcription" checkbox is available in the export dialog [FR30].
2. When enabled, the application transcribes the audio from the exported video using an AI service [FR30].
3. The transcription is saved as a separate plain text (.txt) file alongside the exported video [FR30].
4. The transcription file name matches the video file name with appropriate extension (e.g., `video.mp4` → `video.txt`) [FR30].
5. The transcription process shows progress feedback to the user [FR30].
6. Transcription errors are handled gracefully with user-friendly messages [FR30].

## Tasks / Subtasks
- [x] Task 1: Add Transcription Option to Export Dialog (AC: 1)
  - [x] Add "Include Transcription" checkbox to ExportDialog component
  - [x] Position checkbox in export settings section
  - [x] Add checkbox state management in ExportDialog
  - [x] Update ExportSettings type to include transcription option
  - [x] Show transcription file format indicator (.txt)
  - [x] Disable checkbox if video has no audio track
  - [x] Add transcription status indicator (enabled/disabled)
- [x] Task 2: Implement Transcription Service (AC: 2, 5, 6)
  - [x] Create TranscriptionService in apps/electron/src/services/transcriptionService.ts
  - [x] Integrate OpenAI Whisper API for transcription
  - [x] Implement API authentication and configuration
  - [x] Create extractAudioFromVideo() method using FFmpeg
  - [x] Implement transcribeAudio() method to call AI service
  - [x] Handle API rate limits and errors
  - [x] Implement retry logic for failed requests
  - [x] Add progress callback for transcription status
  - [x] Handle transcription cancellation
- [x] Task 3: Add Transcription IPC Handlers (AC: 2, 5)
  - [x] Add 'transcribe-video' IPC handler
  - [x] Add 'transcription-progress' IPC event
  - [x] Add 'transcription-complete' IPC event
  - [x] Add 'transcription-error' IPC event
  - [x] Update preload.ts to expose transcription API
  - [x] Update electron.d.ts with transcription types
- [x] Task 4: Implement Transcription Text File Generation (AC: 3, 4)
  - [x] Parse AI service response (text only for plain text format)
  - [x] Format transcription as plain text (no timestamps needed)
  - [x] Save .txt file alongside exported video
  - [x] Match .txt filename to video filename (replace extension)
  - [x] Handle file path generation and validation
  - [x] Ensure text file encoding is UTF-8
- [x] Task 5: Integrate Transcription with Export Workflow (AC: 2, 5)
  - [x] Trigger transcription after successful video export
  - [x] Extract audio from exported video file using FFmpeg
  - [x] Pass extracted audio to transcription service
  - [x] Show transcription progress in export dialog or separate indicator
  - [x] Handle transcription as optional step (non-blocking on errors)
  - [x] Complete export workflow even if transcription fails
  - [x] Show success notification for both video and transcription
- [x] Task 6: Add Transcription Configuration and API Key Management (AC: 1, 2)
  - [x] Create transcription settings/preferences structure
  - [x] Add OpenAI API key input field to ExportDialog or Settings dialog
  - [x] Store API key securely using Electron's safeStorage API
  - [x] Handle missing API key gracefully (show prompt/validation before export)
  - [x] Validate API key format before saving (basic format check)
  - [x] Show API key status indicator (configured/not configured)
- [x] Task 7: Implement Error Handling and User Feedback (AC: 6)
  - [x] Catch transcription API errors (rate limits, authentication, network)
  - [x] Display user-friendly error messages
  - [x] Show transcription progress during processing
  - [x] Handle audio extraction failures
  - [x] Handle file writing errors for text file
  - [x] Log transcription errors for debugging
  - [x] Allow export to succeed even if transcription fails
  - [x] Show notification when transcription completes successfully
- [x] Task 8: Optimize Transcription Performance (AC: 2, 5)
  - [x] Extract audio in MP3 format (smaller file size, faster upload, OpenAI Whisper accepts MP3)
  - [x] Handle large video files (chunking or streaming if needed)
  - [x] Show accurate progress estimation
  - [x] Cancel transcription if user cancels export
  - [x] Clean up temporary audio files after transcription
  - [x] Handle transcription timeout scenarios
- [x] Task 9: Add Transcription File Location Management (AC: 3, 4)
  - [x] Save .txt file in same directory as exported video
  - [x] Generate unique filename based on video filename
  - [x] Handle filename conflicts (append number if needed)
  - [x] Show transcription file location in success message
  - [x] Add option to open transcription file location (optional)
- [x] Task 10: Update Export Dialog UI for Transcription (AC: 1, 5)
  - [x] Show transcription progress indicator during export
  - [x] Display transcription status messages
  - [x] Update progress bar to show transcription stage
  - [x] Show transcription checkbox enabled/disabled state
  - [x] Add tooltip or help text explaining transcription feature
  - [x] Show transcription format and file info

## Dev Notes

### Previous Story Insights
From Story 2.7: Full timeline export exists with ExportDialog component. Export workflow handles multi-track composition, resolution scaling, and progress tracking. FFmpegService.exportTimeline() processes complete timeline exports. ExportSettings interface exists with resolution, quality, format settings.

From Story 1.6: Basic export functionality exists. ExportDialog component exists in apps/renderer/src/components/export/. ProgressBar component exists for showing export progress.

**Current State**: Export functionality fully implemented. No transcription capabilities exist yet. This story adds optional AI transcription as a post-export step.

### Data Models
**ExportSettings Extension** [Source: Story 2.7]:
```typescript
interface ExportSettings {
  resolution: '720p' | '1080p' | 'source';
  quality: 'low' | 'medium' | 'high';
  format: 'mp4';
  fps: number;
  bitrate: number;
  audioBitrate: number;
  includeTranscription?: boolean; // NEW
}
```

**Transcription Configuration**:
```typescript
interface TranscriptionConfig {
  apiKey: string; // OpenAI API key
  model?: string; // AI model to use (default: 'whisper-1')
}
```

**Transcription Result**:
```typescript
interface TranscriptionResult {
  text: string; // Plain text transcription from OpenAI Whisper API
  // When response_format is "text", OpenAI returns plain string
  // This interface wraps it for consistency in the application
}
```

**User Preferences for API Key** (stored securely):
- Stored using Electron's `safeStorage` API (encrypted OS keychain/credential manager)
- Location: User preferences/config file (e.g., `~/.clipforge/config.json` or Electron's app.getPath('userData'))

**Transcription Progress**:
```typescript
interface TranscriptionProgress {
  stage: 'extracting' | 'transcribing' | 'formatting' | 'complete';
  progress: number; // 0-100
  message: string;
}
```

### API Specifications
**IPC Commands** [Source: architecture.md#api-specification]:
```typescript
// New IPC commands
'transcribe-video': {
  videoFilePath: string;
  transcriptionConfig: TranscriptionConfig;
} => Promise<{ transcriptionFilePath: string }>;

// IPC events (main → renderer)
'transcription-progress': TranscriptionProgress;
'transcription-complete': { transcriptionFilePath: string };
'transcription-error': { error: string };
```

**TranscriptionService Methods**:
```typescript
class TranscriptionService {
  extractAudioFromVideo(videoPath: string, outputPath: string): Promise<string>;
  transcribeAudio(
    audioPath: string,
    config: TranscriptionConfig,
    onProgress?: (progress: TranscriptionProgress) => void
  ): Promise<TranscriptionResult>;
  formatAsPlainText(transcription: TranscriptionResult): string;
  saveTranscription(content: string, outputPath: string): Promise<void>;
}
```

**AI Service Integration**:
- **Service**: OpenAI Whisper API (CONFIRMED)
  - Endpoint: POST https://api.openai.com/v1/audio/transcriptions
  - Authentication: Bearer token (API key in Authorization header)
  - Format: Multipart form data with audio file
  - Request parameters:
    - `file`: Audio file (multipart form data)
    - `model`: "whisper-1" (default)
    - `language`: Optional (auto-detect if not specified)
    - `response_format`: "text" (for plain text output)
  - Response: Plain text transcription (when response_format is "text")
  - Rate Limits: See OpenAI API documentation
  - Pricing: Per-minute pricing (see OpenAI website)

### Component Specifications
**ExportDialog Component Enhancement** [Source: Story 2.7]:
- Add "Include Transcription" checkbox in export settings
- Show transcription format indicator (.txt)
- Display transcription progress during export (integrated with export progress)
- Show transcription status messages ("Transcribing audio...", "Transcription complete")
- Handle transcription checkbox state
- Show transcription file location after completion
- Add OpenAI API key input field (or link to settings if separate)
- Validate API key before enabling transcription option

**TranscriptionService Component** [Source: architecture.md#components]:
- Location: apps/electron/src/services/transcriptionService.ts
- Responsibilities:
  - Audio extraction from video files
  - OpenAI Whisper API integration
  - Plain text transcription formatting
  - File writing and management
  - Error handling and retry logic
  - API key management and validation

**FFmpegService Extension** (if needed):
- Add extractAudioFromVideo() helper method
- Extract audio in WAV or MP3 format for transcription

### File Locations
**New Files**:
- `apps/electron/src/services/transcriptionService.ts` - Transcription service implementation
- `apps/electron/src/utils/preferencesService.ts` - User preferences/API key storage (if not exists)

**Modified Files**:
- `apps/renderer/src/components/export/ExportDialog.tsx` - Add transcription checkbox and progress
- `apps/electron/src/handlers/ipcHandlers.ts` - Add transcription IPC handlers
- `apps/electron/src/main.ts` - Register transcription service (if needed)
- `apps/electron/src/preload.ts` - Expose transcription API
- `apps/renderer/src/services/electronService.ts` - Add transcription methods
- `apps/renderer/src/types/electron.d.ts` - Add transcription type definitions
- `packages/shared/src/types.ts` - Extend ExportSettings interface
- `apps/renderer/src/App.tsx` - Handle transcription progress events

### Testing Requirements
**Testing Standards** [Source: architecture.md#tech-stack]:
- Manual testing for MVP
- Test file location: apps/electron/tests/
- Test cases: Transcription checkbox, API integration, text file generation, error handling
- Performance: Transcription should not block export, should complete within reasonable time

**Key Test Cases**:
- Check "Include Transcription" checkbox appears in export dialog
- Checkbox is checked/unchecked correctly
- Export with transcription enabled generates .txt file
- .txt file is saved next to exported video with matching filename
- .txt file contains plain text transcription (no timestamps)
- Transcription progress messages appear during processing
- Transcription completes successfully for short video (< 1 min)
- Transcription completes successfully for medium video (1-5 min)
- Transcription completes successfully for long video (5-15 min)
- Transcription fails gracefully if API key is missing
- Transcription fails gracefully if API key is invalid
- Transcription fails gracefully if network error occurs
- Transcription fails gracefully if video has no audio
- Export succeeds even if transcription fails
- Transcription progress updates correctly during processing
- Transcription can be cancelled (if cancellation implemented)
- Multiple exports with transcription work correctly
- .txt file encoding is UTF-8
- .txt file contains readable transcription text
- Transcription handles multiple speakers (if AI service supports)
- Transcription language auto-detection works (if enabled)
- Transcription with specified language works correctly

### Technical Constraints
**AI Service Integration** [Source: architecture.md#coding-standards]:
- API key must be stored securely (environment variable or secure storage)
- API calls must handle rate limits gracefully
- Network requests must have timeout handling
- Authentication errors must be user-friendly
- API costs should be considered (may require usage limits or warnings)

**Audio Extraction** [Source: architecture.md#coding-standards]:
- Extract audio using FFmpeg to temporary file
- Use MP3 format (smaller file size, faster upload to OpenAI API, sufficient quality for transcription)
- Clean up temporary audio files after transcription
- Handle audio extraction errors gracefully
- Note: MP3 format is preferred over WAV for API upload efficiency

**Plain Text File Format** [Source: architecture.md#coding-standards]:
- Plain text format: Simple text transcription without timestamps
- File encoding must be UTF-8
- Handle special characters and punctuation correctly
- Preserve paragraph breaks if AI service provides them
- No formatting markup needed (plain text only)

**Error Handling** [Source: architecture.md#coding-standards]:
- Transcription errors should not block video export
- User-friendly error messages for common failures
- Log detailed errors for debugging
- Handle API rate limits with appropriate messages
- Handle network timeouts gracefully
- Handle file system errors for text file writing

**Performance Considerations** [Source: architecture.md#performance-optimization]:
- Transcription is async and non-blocking
- Show progress feedback during transcription
- Handle large video files efficiently (may need chunking)
- Optimize audio extraction speed
- Consider transcription timeout for very long videos

**Security Considerations** [Source: architecture.md#coding-standards]:
- API keys must not be committed to version control
- Store API keys using Electron's `safeStorage` API (encrypted OS keychain)
- Do not log API keys in console or files
- Handle API key validation securely
- API keys stored in user's OS credential manager (macOS Keychain, Windows Credential Manager, Linux secret service)

**Integration Notes** [Source: Story 2.7]:
- Transcription triggers after successful video export
- Uses exported video file as source (not original timeline)
- Transcription is optional - export workflow unchanged if disabled
- Progress updates can be shown in existing ExportDialog
- Transcription errors do not affect video export success

## Testing

### Testing Standards
- **Test Approach**: Manual testing for MVP
- **Test Location**: apps/electron/tests/
- **Test Framework**: Manual verification only
- **Key Test Cases**:
  - Export dialog shows "Include Transcription" checkbox
  - Checkbox can be checked/unchecked
- Exporting with transcription enabled generates .txt file
- .txt file is saved with correct name next to video
- .txt file contains readable plain text transcription
  - Transcription progress messages appear during export
  - Transcription completes successfully for various video lengths
  - Transcription errors do not block video export
  - Missing API key shows helpful error message
  - Invalid API key shows helpful error message
  - Network errors handled gracefully
  - Video with no audio skips transcription or shows warning
- .txt file encoding is UTF-8
- .txt file content is readable and complete
  - Multiple exports with transcription work correctly

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Product Owner Sarah |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
Claude 3.5 Sonnet (via Cursor)

### Debug Log References
*No debug logs generated during implementation*

### Completion Notes List
- ✅ All 10 tasks completed successfully
- ✅ Transcription checkbox added to ExportDialog with API key input
- ✅ TranscriptionService implemented with OpenAI Whisper API integration
- ✅ IPC handlers added for transcription workflow
- ✅ Export workflow updated to trigger transcription after video export
- ✅ Error handling implemented with soft fail approach
- ✅ Progress tracking integrated into existing export progress bar
- ✅ File naming follows specification: video.mp4 → video.txt
- ✅ UTF-8 encoding ensured for text files
- ✅ Temporary audio files cleaned up after transcription
- ✅ Fixed OpenAI API language parameter issue (removed 'auto' to enable auto-detection)

### File List
**New Files:**
- `apps/electron/src/services/transcriptionService.ts` - Main transcription service implementation

**Modified Files:**
- `packages/shared/src/types.ts` - Added transcription types and extended ExportSettings
- `apps/renderer/src/components/export/ExportDialog.tsx` - Added transcription UI and validation
- `apps/electron/src/services/ffmpegService.ts` - Added extractAudio method
- `apps/electron/src/handlers/ipcHandlers.ts` - Added transcription IPC handlers
- `apps/electron/src/preload.ts` - Exposed transcription API
- `apps/renderer/src/types/electron.d.ts` - Added transcription type definitions
- `apps/renderer/src/services/electronService.ts` - Added transcribeVideo method
- `apps/renderer/src/App.tsx` - Updated export workflow to include transcription

## QA Results
*Results from QA Agent review will be populated here*

---

## API Key Management Options

### Option 1: In Export Dialog (Simplest - Recommended for MVP)
**Implementation:**
- Add OpenAI API key input field directly in ExportDialog
- Show field when "Include Transcription" checkbox is checked
- Input type: `password` (masked)
- Validate key format before export
- Store using Electron's `safeStorage` API after first use
- Show "Remember API key" checkbox (optional)

**Pros:**
- Simple, immediate setup
- No separate settings dialog needed
- User sees it when they need it

**Cons:**
- Takes up space in export dialog
- Less discoverable if user doesn't see it

### Option 2: Settings/Preferences Dialog (Better UX)
**Implementation:**
- Create Settings/Preferences dialog (if doesn't exist)
- Add "Transcription" section with API key field
- Store using Electron's `safeStorage` API
- Link to settings from ExportDialog if key missing
- Show API key status in ExportDialog (✓ configured / ⚠ not configured)

**Pros:**
- Cleaner export dialog
- Centralized configuration
- Better for multiple settings later

**Cons:**
- Requires creating settings dialog (if doesn't exist)
- Additional navigation step

### Option 3: Prompt on First Use (Hybrid)
**Implementation:**
- No API key field in ExportDialog initially
- When user checks "Include Transcription" and key missing:
  - Show modal/prompt asking for API key
  - Input field with "Save" and "Cancel" buttons
  - Store using Electron's `safeStorage` API
- After saved, checkbox works normally

**Pros:**
- Clean export dialog
- Progressive disclosure (only when needed)
- Simple initial state

**Cons:**
- Modal interrupt during export flow
- Can't preview/edit saved key easily

### Recommendation: **Option 3 (Hybrid)** for MVP
- Keeps export dialog clean
- Shows prompt only when needed
- Easy to upgrade to Option 2 later if more settings needed

