# Story 2.2: Implement Split and Delete Clip Functionality

## Status
Ready for Review

## Story
**As a** user,
**I want** to split a clip at the playhead and delete clips from the timeline,
**so that** I have more precise editing control.

## Acceptance Criteria
1. A "Split" action is available that divides the selected clip at the current playhead position into two independent clips [FR17].
2. A "Delete" action is available that removes the selected clip(s) from the timeline [FR18].
3. The preview updates correctly reflect splits and deletions [FR22].

## Tasks / Subtasks
- [x] Task 1: Implement Split Action UI (AC: 1)
  - [x] Add "Split" button/menu item to timeline context menu or toolbar
  - [x] Add keyboard shortcut for split action (e.g., "S" key)
  - [x] Enable split action only when clip is selected and playhead is within clip bounds
  - [x] Show visual feedback when split action is available
  - [x] Handle edge cases (playhead at clip start/end, no clip selected)
- [x] Task 2: Implement Split Clip Logic (AC: 1)
  - [x] Add splitClip action to timelineStore
  - [x] Calculate split point based on playhead position within selected clip
  - [x] Create two new TimelineClip instances from original clip
  - [x] First clip: original startTime to split point, original trimStart to calculated trimEnd
  - [x] Second clip: split point to original endTime, calculated trimStart to original trimEnd
  - [x] Remove original clip and add both new clips to track
  - [x] Preserve clip selection on appropriate new clip (typically second clip)
  - [x] Update timeline duration if needed
- [x] Task 3: Implement Delete Action UI (AC: 2)
  - [x] Add "Delete" button/menu item to timeline context menu or toolbar
  - [x] Add keyboard shortcut for delete action (e.g., Delete/Backspace key)
  - [x] Show confirmation dialog for delete action (optional, based on UX)
  - [x] Enable delete action when clip(s) are selected
  - [x] Support deleting multiple selected clips at once
- [x] Task 4: Implement Delete Clip Logic (AC: 2)
  - [x] Extend removeClipFromTrack to handle multiple clips
  - [x] Remove clip(s) from track.clips array
  - [x] Deselect deleted clips
  - [x] Update timeline duration if deleted clips were at the end
  - [x] Handle timeline gaps created by deletions (adjust subsequent clips or leave gaps)
  - [x] Clean up any clip-specific state or references
- [x] Task 5: Update Preview for Split Operations (AC: 3)
  - [x] Ensure VideoPlayer recalculates active clip after split
  - [x] Handle playhead position transitions across split boundary
  - [x] Maintain playback continuity when split occurs during playback
  - [x] Update preview source when clip is split at current playhead
  - [x] Preserve audio/video sync after split operation
- [x] Task 6: Update Preview for Delete Operations (AC: 3)
  - [x] Update VideoPlayer to handle deleted clips
  - [x] Switch preview to adjacent clip if current clip is deleted
  - [x] Handle empty timeline scenario (no clips remaining)
  - [x] Maintain playhead position or adjust to valid position after deletion
  - [x] Ensure preview doesn't reference deleted clip data
- [x] Task 7: Add Clip Selection Management (AC: 1, 2)
  - [x] Ensure selected clip is highlighted visually
  - [x] Support multi-clip selection (Ctrl/Cmd + click)
  - [x] Handle selection state updates after split/delete
  - [x] Update TimelineClip component to show selection state
  - [x] Ensure split preserves appropriate selection (typically second half)
- [x] Task 8: Add Context Menu for Timeline Operations (AC: 1, 2)
  - [x] Create TimelineContextMenu component
  - [x] Show context menu on right-click over timeline clip
  - [x] Include Split and Delete options in context menu
  - [x] Enable/disable options based on selection and playhead position
  - [x] Position context menu near click point
  - [x] Handle context menu dismissal on outside click

## Dev Notes

### Previous Story Insights
From Story 2.1: Multiple clips can be imported and arranged on timeline. TimelineClip components are draggable. TimelineStore manages array of TimelineClips with addClipToTrack, removeClipFromTrack actions.

From Story 1.5: Basic trim functionality exists. Clips have trimStart and trimEnd properties. Trim mode allows setting in/out points.

From Story 1.4: VideoPlayer component handles clip playback and preview synchronization with playhead position. Active clip is determined by playhead position within clip startTime/endTime bounds.

### Data Models
**TimelineClip Split Operation** [Source: architecture.md#data-models]:
- Original clip: `{ id: "clip-1", startTime: 0, endTime: 30, trimStart: 0, trimEnd: 30 }`
- Split at playhead position 15 seconds:
  - First clip: `{ id: "clip-1a", startTime: 0, endTime: 15, trimStart: 0, trimEnd: 15 }`
  - Second clip: `{ id: "clip-1b", startTime: 15, endTime: 30, trimStart: 15, trimEnd: 30 }`
- Both clips reference same videoClipId (same source video)
- Clips maintain independent trimStart/trimEnd for future editing

**TimelineClip Deletion** [Source: architecture.md#data-models]:
- Remove clip from TimelineTrack.clips array
- No cascading deletion of VideoClip (source video remains in project)
- Timeline duration may need adjustment if deleted clips were at end
- Consider gap handling strategy (leave gaps vs. close gaps)

### API Specifications
**Timeline Store Actions** [Source: architecture.md#frontend-architecture]:
```typescript
// New actions for timelineStore
splitClip: (clipId: string, splitTime: number) => void;
deleteClip: (clipId: string) => void;
deleteClips: (clipIds: string[]) => void; // Batch delete
selectClip: (clipId: string, multiSelect?: boolean) => void; // Enhanced
getClipAtPlayhead: () => TimelineClip | null;
```

**IPC Updates** [Source: architecture.md#api-specification]:
- No IPC changes required - split/delete are UI-only operations
- Export will handle split clips automatically (uses trimStart/trimEnd)

### Component Specifications
**Timeline Component** [Source: architecture.md#components]:
- Add context menu handler for right-click on clips
- Integrate TimelineContextMenu component
- Handle keyboard shortcuts (S for split, Delete/Backspace for delete)
- Update clip selection visual feedback
- Pass split/delete handlers to TimelineClip components

**TimelineClip Component** [Source: architecture.md#components]:
- Show selection visual state (border, highlight)
- Handle right-click to show context menu
- Support keyboard shortcut activation
- Update visual representation after split/delete operations

**TimelineContextMenu Component** [Source: architecture.md#components]:
- Display Split and Delete menu options
- Position menu near right-click location
- Enable/disable options based on context:
  - Split: enabled when clip selected AND playhead within clip bounds
  - Delete: enabled when clip(s) selected
- Handle menu option clicks
- Dismiss on outside click or Escape key

**VideoPlayer Component** [Source: architecture.md#components]:
- Recalculate active clip after split/delete operations
- Handle playhead position when current clip is split
- Switch to adjacent clip if current clip is deleted
- Handle empty timeline (no active clip)
- Maintain playback state during operations

### File Locations
**Modified Files** [Source: architecture.md#unified-project-structure]:
- `apps/renderer/src/components/timeline/Timeline.tsx` - Context menu, keyboard shortcuts
- `apps/renderer/src/components/timeline/TimelineClip.tsx` - Selection state, context menu trigger
- `apps/renderer/src/components/preview/VideoPlayer.tsx` - Handle split/delete in preview
- `apps/renderer/src/stores/timelineStore.ts` - Split/delete actions, selection management
- `apps/renderer/src/App.tsx` - Global keyboard shortcuts (if needed)

**New Files**:
- `apps/renderer/src/components/timeline/TimelineContextMenu.tsx` - Context menu component

### Testing Requirements
**Testing Standards** [Source: architecture.md#tech-stack]:
- Manual testing for MVP
- Test file location: apps/renderer/tests/
- Test cases: Split operations, delete operations, preview updates, edge cases
- Performance: Operations should be instant, no UI lag

**Key Test Cases**:
- Split clip at middle point - creates two clips correctly
- Split clip at start - should handle gracefully (no zero-duration clip)
- Split clip at end - should handle gracefully (no zero-duration clip)
- Split preserves trim points correctly in both new clips
- Delete single clip removes it from timeline
- Delete multiple clips removes all selected clips
- Delete clip updates preview (switches to adjacent clip)
- Delete all clips handles empty timeline gracefully
- Split during playback maintains continuity
- Preview correctly reflects split boundaries
- Selection preserved appropriately after split (typically second clip)
- Keyboard shortcuts work correctly (S for split, Delete for delete)
- Context menu appears on right-click
- Context menu options enabled/disabled correctly
- Split/delete operations are undoable (if undo system exists)

### Technical Constraints
**Split Operation Constraints** [Source: architecture.md#coding-standards]:
- Split point must be within clip bounds (startTime < splitTime < endTime)
- Both resulting clips must have valid duration (> 0)
- Trim points must be recalculated correctly:
  - First clip: trimEnd = original trimStart + (splitTime - startTime)
  - Second clip: trimStart = original trimStart + (splitTime - startTime)
- VideoClip reference (videoClipId) remains same for both clips
- Clips maintain their track assignment

**Delete Operation Constraints** [Source: architecture.md#coding-standards]:
- Deletion removes TimelineClip from track, not VideoClip from project
- VideoClip remains available for re-adding to timeline
- Timeline gaps may be created - decide on strategy (leave gaps vs. close)
- Timeline duration should update if deleted clips were at end
- Preview must handle deleted clip references gracefully

**State Management** [Source: architecture.md#frontend-architecture]:
- Zustand store updates must be immutable
- Selection state must be cleared for deleted clips
- Playhead position may need adjustment if current clip is deleted
- Timeline duration updates after operations

**Preview Synchronization** [Source: architecture.md#performance-optimization]:
- Preview must update immediately after split/delete
- Active clip calculation must account for new clip structure
- Playback continuity must be maintained
- Audio/video sync must be preserved

**UI Responsiveness** [Source: architecture.md#performance-optimization]:
- Split/delete operations must be instant (< 100ms)
- No UI blocking during operations
- Visual feedback for user actions
- Context menu must appear/disappear smoothly

## Testing

### Testing Standards
- **Test Approach**: Manual testing for MVP
- **Test Location**: apps/renderer/tests/
- **Test Framework**: Manual verification only
- **Key Test Cases**:
  - Select clip and split at playhead - creates two clips
  - Split at clip start - handled gracefully (no error)
  - Split at clip end - handled gracefully (no error)
  - Delete single selected clip - removes from timeline
  - Select multiple clips and delete - removes all
  - Delete clip that preview is currently showing - switches to adjacent clip
  - Split clip during playback - maintains continuity
  - Preview correctly shows split boundaries
  - Keyboard shortcut S splits clip correctly
  - Keyboard shortcut Delete removes clip correctly
  - Right-click shows context menu with Split/Delete options
  - Context menu options enabled/disabled based on context
  - Timeline updates visually after split/delete
  - Empty timeline handled gracefully after deleting all clips

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master Bob |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
*No blocking issues encountered during implementation*

### Completion Notes List
- Implemented splitClip action in timelineStore that:
  - Validates split time is within clip bounds with 0.1s minimum on each side
  - Creates two new clips with correct trimStart/trimEnd values
  - Selects the second clip after split (standard editing behavior)
  - Maintains originalDuration for both clips
- Implemented deleteClip and deleteClips actions in timelineStore:
  - Supports batch deletion of multiple clips
  - Recalculates timeline duration after deletion
  - Properly cleans up clip references
- Created TimelineContextMenu component with:
  - Trim, Split and Delete menu options
  - Keyboard shortcut indicators (T for trim, S for split, Del for delete)
  - Enable/disable logic based on context
  - Auto-dismissal on outside click or Escape key
  - Smart positioning to stay on screen (opens upward/leftward when near edges)
- Added keyboard shortcuts to Timeline component:
  - S key: splits clip at playhead position (only if playhead within clip bounds)
  - Delete/Backspace: deletes all selected clips
  - Context menu on right-click
- Enhanced Timeline component with:
  - splitClip, deleteClips, and getClipAtPlayhead actions from timelineStore
  - Context menu state management
  - canSplit, canDelete, and canTrim computed properties for UI feedback
  - Toolbar buttons for Trim, Split, and Delete operations
  - Animated pulse effect on Trim button when trim mode is active
- Preview (VideoPlayer) already handles split/delete operations correctly:
  - timelineSequence useMemo recalculates activeClip when timeline.tracks changes
  - Clip transitions handled by existing useEffect logic
  - Empty timeline (no activeClip) properly handled
- Multi-clip selection already implemented via selectClip action
- Visual selection feedback already present in TimelineClip component (white border for selection)
- Fixed clip selection bug: clicking on clip now always selects it immediately
- Updated visual styling: removed borders from unselected clips, white border only for selected clips
- Fixed scissors emoji bug: now correctly checks against originalDuration, not clipDuration
- Added media library indication: blue ring border when timeline clip uses that source video
- Icon updates: Scissors for Trim, TableColumnsSplit for Split, Trash2 for Delete

### File List
**New Files:**
- `apps/renderer/src/components/timeline/TimelineContextMenu.tsx` - Context menu component for trim/split/delete operations with smart positioning

**Modified Files:**
- `apps/renderer/src/stores/timelineStore.ts` - Added splitClip, deleteClip, deleteClips, getClipAtPlayhead, and selectClipMulti actions
- `apps/renderer/src/components/timeline/Timeline.tsx` - Added keyboard shortcuts, context menu integration, split/delete/trim toolbar buttons with visual feedback
- `apps/renderer/src/components/timeline/TimelineClip.tsx` - Fixed selection logic to trigger immediately on click, fixed scissors emoji to check originalDuration, removed unused clipDuration variable
- `apps/renderer/src/components/media/MediaLibrary.tsx` - Added visual indication (blue ring) when source video is used by selected timeline clip
- `apps/renderer/src/App.tsx` - Passed selectedClip.id to MediaLibrary for source indication
- `docs/stories/2.2.implement-split-delete-clip-functionality.md` - Updated task checkboxes and Dev Agent Record

## QA Results
*Results from QA Agent review will be populated here*

