# Story 2.3: Implement Multiple Timeline Tracks

## Status
Approved

## Story
**As a** user,
**I want** to place clips on at least two different tracks,
**so that** I can create overlays or Picture-in-Picture effects.

## Acceptance Criteria
1. The timeline interface displays at least two distinct video tracks [FR19].
2. Users can drag clips onto either track.
3. The preview window correctly composites video from multiple tracks (e.g., top track overlays bottom track) [FR22].

## Tasks / Subtasks
- [ ] Task 1: Initialize Multiple Tracks on Timeline (AC: 1)
  - [ ] Update timeline initialization to create at least 2 video tracks by default
  - [ ] Update createTimelineTracks to support multiple tracks
  - [ ] Ensure tracks are displayed with distinct visual styling
  - [ ] Add track headers with track names and controls
  - [ ] Ensure tracks are properly spaced vertically in timeline
- [ ] Task 2: Enhance Timeline UI for Multiple Tracks (AC: 1)
  - [ ] Update Timeline component to render multiple TimelineTrack components
  - [ ] Add visual distinction between tracks (borders, alternating colors)
  - [ ] Display track labels/names in track headers
  - [ ] Calculate track positions and heights correctly
  - [ ] Ensure timeline ruler spans all tracks
  - [ ] Handle vertical scrolling if many tracks
- [ ] Task 3: Implement Drag & Drop to Specific Tracks (AC: 2)
  - [ ] Update TimelineTrack component to accept drops
  - [ ] Calculate which track is targeted during drag operation
  - [ ] Handle drag from Media Library onto specific track
  - [ ] Handle drag from one track to another track
  - [ ] Update addClipToTrack to target specific trackId
  - [ ] Validate drop target (correct track type, valid position)
- [ ] Task 4: Update Track Visual Layout (AC: 1)
  - [ ] Ensure TimelineTrack renders clips at correct positions
  - [ ] Visual styling distinguishes tracks (colors, borders)
  - [ ] Track headers show track type (Video Track 1, Video Track 2)
  - [ ] Tracks can be collapsed/expanded (optional enhancement)
  - [ ] Handle empty tracks with proper visual feedback
- [ ] Task 5: Implement Multi-Track Preview Composition (AC: 3)
  - [ ] Update VideoPlayer to handle multiple tracks
  - [ ] Calculate which clips are active at current playhead across all tracks
  - [ ] Determine rendering order (higher track numbers overlay lower)
  - [ ] Composite video layers using Canvas API or HTML5 video stacking
  - [ ] Handle transparency/alpha for overlay effects (if needed)
  - [ ] Maintain proper aspect ratio and scaling for overlays
- [ ] Task 6: Implement Canvas-Based Video Composition (AC: 3)
  - [ ] Create VideoCompositor utility/service
  - [ ] Use HTML5 Canvas to composite multiple video sources
  - [ ] Render bottom track video as base layer
  - [ ] Render top track video(s) as overlay layers
  - [ ] Handle video positioning and sizing for PiP effects
  - [ ] Maintain smooth playback (30fps target) during composition
- [ ] Task 7: Handle Track Order and Layering (AC: 3)
  - [ ] Define track rendering order (higher index = top layer)
  - [ ] Calculate clip stacking at playhead position
  - [ ] Handle partial overlaps (top track partially covers bottom)
  - [ ] Update preview when clips are moved between tracks
  - [ ] Ensure preview reflects current track configuration
- [ ] Task 8: Update Timeline Store for Multi-Track (AC: 1, 2, 3)
  - [ ] Ensure addTrack creates tracks with unique IDs
  - [ ] Ensure addClipToTrack targets correct track
  - [ ] Update track management functions for multi-track
  - [ ] Add helper to get clips at playhead across all tracks
  - [ ] Track track order for composition rendering

## Dev Notes

### Previous Story Insights
From Story 2.2: Split and delete operations work on individual clips within tracks. Clips can be selected and manipulated on timeline.

From Story 2.1: Multiple clips can be imported and arranged. Drag & drop functionality exists for clips on timeline.

From Story 1.4: VideoPlayer handles single clip playback with preview synchronization. Preview uses HTML5 video element for playback.

**Current State**: Timeline already has track structure (TimelineTrack interface, addTrack/removeTrack actions), but currently defaults to single track. TimelineTrack component exists and renders clips.

### Data Models
**TimelineTrack Structure** [Source: architecture.md#data-models]:
- Multiple TimelineTrack instances in timeline.tracks array
- Each track has: id, name, type ('video' | 'audio'), clips[], muted, volume
- Track order in array determines layering order (higher index = top layer)
- Clips on different tracks can overlap in time (same startTime/endTime)

**TimelineClip Track Assignment** [Source: architecture.md#data-models]:
- TimelineClip.trackId references the TimelineTrack.id
- Clips can be moved between tracks by changing trackId
- Clips on same track maintain sequential ordering
- Clips on different tracks are independent in ordering

**Multi-Track Composition** [Source: architecture.md#data-models]:
- At any playhead position, multiple clips from different tracks may be active
- Composition order: tracks[0] = bottom, tracks[n] = top
- Top track videos overlay bottom track videos
- All tracks render simultaneously if clips overlap in time

### API Specifications
**Timeline Store Actions** [Source: architecture.md#frontend-architecture]:
```typescript
// Existing track actions (already in timelineStore)
addTrack: (track: Omit<TimelineTrack, "id">) => void;
removeTrack: (trackId: string) => void;
updateTrack: (trackId: string, updates: Partial<TimelineTrack>) => void;

// Enhanced clip actions
addClipToTrack: (trackId: string, clip: Omit<TimelineClip, "id">) => void; // Already exists
moveClipToTrack: (clipId: string, newTrackId: string) => void; // New

// New helper functions
getActiveClipsAtTime: (time: number) => TimelineClip[]; // Returns clips from all tracks
getTracksAtTime: (time: number) => TimelineTrack[]; // Returns tracks with active clips
```

**IPC Updates** [Source: architecture.md#api-specification]:
- No IPC changes required - multi-track is UI-only for preview
- Export will handle multi-track composition via FFmpeg (covered in Story 2.7)

### Component Specifications
**Timeline Component** [Source: architecture.md#components]:
- Render multiple TimelineTrack components based on timeline.tracks
- Calculate track vertical positions and heights
- Handle drop zone calculation to determine target track
- Pass correct track context to each TimelineTrack component
- Ensure ruler spans all tracks visually

**TimelineTrack Component** [Source: architecture.md#components]:
- Display track header with track name
- Render clips within track bounds
- Handle drop operations specific to this track
- Visual styling to distinguish from other tracks
- Show track type indicator (video/audio)
- Handle track-specific interactions

**VideoPlayer Component** [Source: architecture.md#components]:
- Determine active clips across all tracks at current playhead
- Load video sources for all active clips simultaneously
- Composite video layers using Canvas API
- Handle layering order (tracks[0] = bottom, tracks[n] = top)
- Maintain smooth playback during multi-layer composition
- Handle video positioning/sizing for overlay effects

**VideoCompositor Service** [Source: architecture.md#components]:
- Create utility class/service for video composition
- Manage multiple HTML5 video elements (one per active clip)
- Use Canvas API to composite video layers
- Handle video synchronization across layers
- Optimize performance for smooth playback
- Handle video loading and disposal

### File Locations
**Modified Files** [Source: architecture.md#unified-project-structure]:
- `apps/renderer/src/components/timeline/Timeline.tsx` - Multi-track rendering, drop zones
- `apps/renderer/src/components/timeline/TimelineTrack.tsx` - Track-specific drop handling
- `apps/renderer/src/components/preview/VideoPlayer.tsx` - Multi-track composition
- `apps/renderer/src/stores/timelineStore.ts` - Multi-track initialization, helpers
- `apps/renderer/src/stores/projectStore.ts` - Ensure tracks persist in project

**New Files**:
- `apps/renderer/src/services/videoCompositor.ts` - Video composition utility (optional, can integrate into VideoPlayer)

### Testing Requirements
**Testing Standards** [Source: architecture.md#tech-stack]:
- Manual testing for MVP
- Test file location: apps/renderer/tests/
- Test cases: Multiple tracks display, drag to tracks, composition preview
- Performance: Smooth preview with 2+ tracks active, maintain 30fps

**Key Test Cases**:
- Timeline displays at least 2 video tracks by default
- Tracks are visually distinct and labeled correctly
- Drag clip from Media Library to Track 1 - clip appears on Track 1
- Drag clip from Media Library to Track 2 - clip appears on Track 2
- Drag clip from Track 1 to Track 2 - clip moves correctly
- Place clip on Track 1 at time 0
- Place clip on Track 2 at time 0 (overlap)
- Preview shows both clips composited (Track 2 overlays Track 1)
- Preview maintains smooth playback with 2 tracks active
- Clips on different tracks can overlap in time
- Moving clip between tracks updates preview immediately
- Timeline visually represents clips on correct tracks
- Track headers display track names correctly

### Technical Constraints
**Track Initialization** [Source: architecture.md#coding-standards]:
- Timeline must initialize with at least 2 video tracks by default
- Track IDs must be unique and stable
- Track names should be descriptive (Video Track 1, Video Track 2)
- Track order determines composition layering

**Drag & Drop to Tracks** [Source: architecture.md#frontend-architecture]:
- Calculate drop target track from mouse Y coordinate
- Consider track header height in drop calculation
- Validate drop target (correct track type, valid position)
- Handle edge cases (drop between tracks, drop outside tracks)
- Update clip trackId when dropped on different track

**Video Composition** [Source: architecture.md#performance-optimization]:
- Use Canvas API for compositing multiple video sources
- Maintain 30fps target during multi-track playback
- Optimize video element creation/disposal
- Handle video synchronization across layers
- Pre-load video sources for smooth transitions

**Canvas Composition Strategy** [Source: architecture.md#coding-standards]:
- Render bottom track video to canvas base layer
- Render top track videos as overlay layers in order
- Handle video sizing and positioning for PiP effects
- Maintain aspect ratios correctly
- Handle transparency/alpha if needed for overlay effects

**State Management** [Source: architecture.md#frontend-architecture]:
- Zustand store must maintain track array correctly
- Track order determines composition order
- Moving clips between tracks must update state immutably
- Preview must react to track changes immediately

**Performance Considerations** [Source: architecture.md#performance-optimization]:
- Multiple video elements must load efficiently
- Canvas composition must not cause lag
- Smooth playback with 2+ active tracks
- Memory management for video elements
- Efficient rendering during multi-track composition

## Testing

### Testing Standards
- **Test Approach**: Manual testing for MVP
- **Test Location**: apps/renderer/tests/
- **Test Framework**: Manual verification only
- **Key Test Cases**:
  - Timeline displays 2+ video tracks on initial load
  - Tracks are visually distinct (borders, colors, labels)
  - Drag clip from Media Library to Track 1 - appears correctly
  - Drag clip from Media Library to Track 2 - appears correctly
  - Drag clip from Track 1 to Track 2 - moves correctly
  - Place overlapping clips on different tracks (same time)
  - Preview composites clips correctly (top track overlays bottom)
  - Preview maintains smooth playback with multi-track composition
  - Moving clip between tracks updates preview immediately
  - Timeline correctly displays clips on their respective tracks
  - Track headers show correct track names
  - Multiple tracks can have clips at same time positions
  - Preview handles empty tracks gracefully

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master Bob |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
TBD

### Debug Log References
*To be populated during implementation*

### Completion Notes List
*To be populated after implementation*

### File List
*To be populated after implementation*

## QA Results
*Results from QA Agent review will be populated here*

