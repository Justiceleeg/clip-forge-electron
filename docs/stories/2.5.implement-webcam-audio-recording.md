# Story 2.5: Implement Webcam and Audio Recording

## Status
Pending

## Story
**As a** user,
**I want** to record video from my webcam and audio from my microphone,
**so that** I can capture direct-to-camera footage or voiceovers.

## Acceptance Criteria
1. User can select an available webcam and initiate recording [FR8].
2. User can select an available microphone and capture audio during webcam or screen recording [FR10].
3. User can stop the recording [FR11].
4. The resulting video/audio files are saved and added to the media library/timeline [FR12].

## Tasks / Subtasks
- [ ] Task 1: Extend Recording Service for Webcam/Microphone (AC: 1, 2, 3)
  - [ ] Add getWebcamDevices() method using navigator.mediaDevices.enumerateDevices()
  - [ ] Add getMicrophoneDevices() method using navigator.mediaDevices.enumerateDevices()
  - [ ] Extend RecordingService to support webcam recording mode
  - [ ] Implement startWebcamRecording(deviceId: string, audioDeviceId?: string)
  - [ ] Use getUserMedia() to get webcam video stream
  - [ ] Use getUserMedia() to get microphone audio stream (optional)
  - [ ] Combine video and audio streams into single MediaStream
  - [ ] Handle device unavailable or permission denied errors
  - [ ] Reuse existing stopRecording() and file saving logic
- [ ] Task 2: Implement Device Selection UI (AC: 1, 2)
  - [ ] Extend RecordingDialog or create WebcamRecordingDialog component
  - [ ] Fetch available webcam devices via IPC or direct API call
  - [ ] Fetch available microphone devices via IPC or direct API call
  - [ ] Display list of available webcams with device names
  - [ ] Display list of available microphones with device names
  - [ ] Allow user to select webcam from dropdown/list
  - [ ] Allow user to select microphone from dropdown/list (optional, can use default)
  - [ ] Show preview of selected webcam feed before recording
  - [ ] Show audio level indicator for selected microphone (optional)
  - [ ] Handle "None" or "No microphone" option for video-only recording
- [ ] Task 3: Add IPC Handlers for Webcam/Audio (AC: 1, 2, 3, 4)
  - [ ] Add 'get-webcam-devices' IPC handler (or use renderer-side API directly)
  - [ ] Add 'get-microphone-devices' IPC handler (or use renderer-side API directly)
  - [ ] Add 'start-webcam-recording' IPC handler
  - [ ] Reuse 'stop-recording' IPC handler from Story 2.4
  - [ ] Reuse existing recording events ('recording-started', 'recording-stopped', 'recording-error')
  - [ ] Update preload.ts to expose webcam recording methods (if IPC needed)
  - [ ] Update electron.d.ts with webcam recording API types
- [ ] Task 4: Enhance Recording Controls for Webcam Mode (AC: 1, 3)
  - [ ] Update RecordingControls to support webcam recording option
  - [ ] Add "Record Webcam" button/menu item
  - [ ] Integrate with device selection dialog
  - [ ] Show webcam preview in recording dialog
  - [ ] Reuse existing recording indicator and timer
  - [ ] Update UI to show recording mode (Screen/Webcam)
  - [ ] Handle stop recording for webcam mode
- [ ] Task 5: Implement Webcam Preview Before Recording (AC: 1)
  - [ ] Request webcam access for preview (getUserMedia with video only)
  - [ ] Display live webcam feed in dialog
  - [ ] Update preview when different webcam is selected
  - [ ] Handle webcam permission requests
  - [ ] Show permission denied error clearly
  - [ ] Clean up preview stream when dialog closes
  - [ ] Handle multiple webcam switching
- [ ] Task 6: Combine Webcam and Microphone Streams (AC: 2)
  - [ ] Request video stream from selected webcam device
  - [ ] Request audio stream from selected microphone device (or default)
  - [ ] Combine streams using MediaStream constructor or addTrack()
  - [ ] Ensure audio/video synchronization
  - [ ] Handle cases where webcam has built-in mic (use webcam audio or separate mic?)
  - [ ] Allow audio-only recording option (for voiceovers)
  - [ ] Handle microphone permission requests
  - [ ] Fallback gracefully if microphone unavailable
- [ ] Task 7: Enable Microphone for Screen Recording (AC: 2)
  - [ ] Extend screen recording to support microphone audio input
  - [ ] Add microphone selection to screen recording dialog
  - [ ] Combine screen video stream with microphone audio stream
  - [ ] Handle system audio + microphone audio mixing (or user choice)
  - [ ] Update screen recording flow to include microphone option
  - [ ] Document audio source options (system audio, microphone, both, none)
- [ ] Task 8: Auto-Import Recorded Webcam Video (AC: 4)
  - [ ] Reuse auto-import logic from Story 2.4 Task 7
  - [ ] Import webcam recordings same as screen recordings
  - [ ] Generate thumbnail for webcam recording
  - [ ] Add recorded clip to media library
  - [ ] Optionally add to timeline (default: add to end of Track 1)
  - [ ] Show success notification
  - [ ] Handle import errors gracefully
- [ ] Task 9: Handle Device Permissions and Errors (AC: 1, 2)
  - [ ] Request camera permission when user opens device selector
  - [ ] Request microphone permission when user selects microphone
  - [ ] Show helpful error messages for permission denied
  - [ ] Guide users to browser/system settings for permissions
  - [ ] Handle device disconnection during recording
  - [ ] Handle device unavailable errors gracefully
  - [ ] Show clear feedback when devices are not found
  - [ ] Test permission flows on macOS, Windows, Linux

## Dev Notes

### Previous Story Insights
From Story 2.4: Recording infrastructure already exists. RecordingService handles screen recording with MediaRecorder. IPC handlers exist for recording operations. RecordingDialog and RecordingControls components are created. Auto-import functionality exists.

**Current State**: Recording service supports screen recording. Need to extend for webcam/microphone device selection and streams.

### Data Models
**Recording State Extension** [Source: Story 2.4]:
```typescript
interface RecordingState {
  isRecording: boolean;
  recordingStartTime: number | null;
  recordingMode: 'screen' | 'webcam' | 'screen+webcam';
  selectedSource: ScreenSource | null;
  selectedWebcam: MediaDeviceInfo | null;
  selectedMicrophone: MediaDeviceInfo | null;
  outputPath: string | null;
}
```

**Device Types**:
```typescript
interface MediaDevice {
  deviceId: string;
  label: string;
  kind: 'videoinput' | 'audioinput';
}
```

### API Specifications
**IPC Commands** [Source: architecture.md#api-specification]:
```typescript
// New IPC commands (or use renderer-side getUserMedia directly)
'get-webcam-devices': () => Promise<MediaDeviceInfo[]>;
'get-microphone-devices': () => Promise<MediaDeviceInfo[]>;
'start-webcam-recording': { 
  webcamDeviceId: string;
  microphoneDeviceId?: string;
  includeAudio?: boolean;
} => Promise<void>;

// Existing commands reused
'stop-recording': () => Promise<{ filePath: string }>;

// IPC events (same as Story 2.4)
'recording-started': { success: boolean; mode: 'screen' | 'webcam' };
'recording-stopped': { filePath: string };
'recording-error': { error: string };
```

**Renderer-Side API** (Alternative - use getUserMedia directly in renderer):
```typescript
// Direct API in renderer (preferred for getUserMedia)
navigator.mediaDevices.enumerateDevices(): Promise<MediaDeviceInfo[]>;
navigator.mediaDevices.getUserMedia(constraints: MediaStreamConstraints): Promise<MediaStream>;
```

**Electron Service API Extension** [Source: Story 2.4]:
```typescript
// Extend electronService with webcam methods
getWebcamDevices(): Promise<MediaDeviceInfo[]>; // If using IPC, else use directly
getMicrophoneDevices(): Promise<MediaDeviceInfo[]>; // If using IPC, else use directly
startWebcamRecording(options: {
  webcamDeviceId: string;
  microphoneDeviceId?: string;
  includeAudio?: boolean;
}): Promise<void>;
// Reuse stopRecording from Story 2.4
```

### Component Specifications
**WebcamRecordingDialog Component** [Source: architecture.md#components]:
- Modal dialog for selecting webcam and microphone
- Display list of available webcam devices
- Display list of available microphone devices
- Live preview of selected webcam feed
- Audio level indicator for microphone (optional)
- Checkbox/dropdown for microphone selection (can be "None")
- Cancel and Start Recording buttons
- Handle permission requests and errors

**RecordingDialog Enhancement** [Source: Story 2.4]:
- Extend existing RecordingDialog to include microphone selection
- Add microphone device selector to screen recording dialog
- Allow microphone selection for both screen and webcam modes
- Show microphone audio level indicator

**RecordingControls Enhancement** [Source: Story 2.4]:
- Add "Record Webcam" button/option
- Show current recording mode (Screen/Webcam)
- Reuse existing recording indicator and timer
- Handle webcam recording state

**RecordingService Extension** [Source: Story 2.4]:
- Extend existing RecordingService to support webcam mode
- Add getUserMedia() calls for webcam/microphone
- Combine video and audio streams
- Reuse existing MediaRecorder and file saving logic
- Handle device-specific errors

### File Locations
**New Files**:
- `apps/renderer/src/components/recording/WebcamRecordingDialog.tsx` - Webcam device selection (or extend RecordingDialog)
- `apps/renderer/src/hooks/useMediaDevices.ts` - Hook for device enumeration (optional, for organization)

**Modified Files**:
- `apps/electron/src/services/recordingService.ts` - Add webcam recording methods
- `apps/electron/src/handlers/ipcHandlers.ts` - Add webcam device handlers (if using IPC)
- `apps/renderer/src/components/recording/RecordingDialog.tsx` - Add webcam/mic selection or create separate dialog
- `apps/renderer/src/components/recording/RecordingControls.tsx` - Add webcam recording option
- `apps/renderer/src/services/electronService.ts` - Add webcam recording methods (if using IPC)
- `apps/renderer/src/types/electron.d.ts` - Add webcam recording types
- `apps/renderer/src/App.tsx` - Integrate webcam recording controls

**Note**: getUserMedia() can be called directly in renderer process (no IPC needed), which is simpler and more standard. IPC may only be needed if device enumeration is done in main process.

### Testing Requirements
**Testing Standards** [Source: architecture.md#tech-stack]:
- Manual testing for MVP
- Test file location: apps/renderer/tests/ (renderer-side testing)
- Test cases: Device enumeration, webcam selection, microphone selection, recording, permissions
- Performance: Recording should not cause UI freezing, preview should be responsive

**Key Test Cases**:
- Click "Record Webcam" opens device selection dialog
- Dialog displays available webcam devices with names
- Dialog displays available microphone devices with names
- Selecting webcam shows live preview feed
- Preview updates when different webcam is selected
- Selecting microphone shows audio level indicator (optional)
- Starting recording with webcam and microphone works correctly
- Starting recording with webcam only (no microphone) works correctly
- Recording indicator appears during webcam recording
- Recording duration timer increments correctly
- Stop recording saves webcam video file correctly
- Recorded file is saved to ~/.clipforge/recordings/
- Recorded file is automatically imported after recording
- Recorded clip appears in media library
- Audio is included in recording when microphone selected
- Recording works without microphone (video only)
- Camera permission denied shows helpful error message
- Microphone permission denied shows helpful error message
- Device unavailable errors handled gracefully
- Device disconnection during recording handled gracefully
- Selecting microphone for screen recording works (Story 2.4 extension)
- Screen recording with microphone audio works
- Screen recording with system audio + microphone works
- Multiple webcam recordings create separate files
- Recording doesn't crash or freeze UI
- Cannot start multiple recordings simultaneously
- Preview feed cleanup when dialog closes
- Webcam preview shows correct feed (not reversed/mirrored issue)

### Technical Constraints
**MediaDevices API** [Source: architecture.md#tech-stack]:
- Use `navigator.mediaDevices.enumerateDevices()` for device list
- Use `navigator.mediaDevices.getUserMedia()` for webcam/microphone access
- Requires HTTPS or localhost in browser (Electron handles this)
- Permission requests are browser-managed
- Device labels require active media stream in some browsers

**Platform Considerations** [Source: architecture.md#development-workflow]:
- **macOS**: Requires camera and microphone permissions in System Preferences
- **Windows**: May require permissions depending on Windows version
- **Linux**: Typically works without special permissions
- Device permissions are per-application
- Users must grant permissions before accessing devices

**Permission Handling** [Source: architecture.md#coding-standards]:
- Request permissions when user opens device selector
- Show clear permission denied messages
- Guide users to system settings if needed
- Handle permission revocation gracefully
- Test permission flows on all target platforms

**Stream Combination** [Source: architecture.md#coding-standards]:
- Combine video and audio streams using MediaStream constructor
- Or add audio track to video stream using addTrack()
- Ensure stream synchronization
- Handle stream disconnection
- Clean up streams on errors

**Webcam-Specific Constraints** [Source: architecture.md#performance-optimization]:
- Webcam preview may show mirrored feed (common UX pattern)
- Handle multiple webcam connections/disconnections
- Optimize preview feed to not consume too much CPU
- Consider resolution/quality settings for recording vs. preview
- Handle webcam busy errors (device in use by another app)

**Audio Constraints** [Source: architecture.md#coding-standards]:
- Some webcams have built-in microphones
- Allow user to choose: use webcam mic or separate microphone
- Handle audio-only recording option (for voiceovers)
- Test audio sync between video and audio tracks
- Handle audio level monitoring for feedback (optional)

**File Management** [Source: Story 2.4]:
- Save webcam recordings to `~/.clipforge/recordings/` directory
- Generate unique filenames: `webcam-recording-YYYY-MM-DD-HHmmss.webm`
- Reuse file saving logic from Story 2.4
- Handle disk space issues gracefully

**Error Handling** [Source: architecture.md#coding-standards]:
- Handle device unavailable errors
- Handle permission denied errors
- Handle device disconnection during recording
- Handle stream errors
- Show user-friendly error messages
- Clean up resources on error
- Recover gracefully from errors

**State Management** [Source: Story 2.4]:
- Extend recording state to include webcam mode
- Track selected devices in state
- Handle device state changes
- Update UI on state changes

**Integration with Story 2.4** [Source: Story 2.4]:
- Reuse RecordingService infrastructure
- Extend RecordingDialog or create separate dialog
- Reuse recording controls
- Reuse auto-import functionality
- Ensure no conflicts between screen and webcam recording modes

## Testing

### Testing Standards
- **Test Approach**: Manual testing for MVP
- **Test Location**: apps/renderer/tests/
- **Test Framework**: Manual verification only
- **Key Test Cases**:
  - Record Webcam button opens device selection dialog
  - Device dialog shows available webcams with names
  - Device dialog shows available microphones with names
  - Selecting webcam shows live preview
  - Preview updates when different webcam selected
  - Starting recording with webcam + microphone works
  - Starting recording with webcam only works
  - Recording indicator appears and shows duration
  - Stop recording saves file successfully
  - Recorded file is in recordings directory
  - Recorded file is automatically imported
  - Recorded clip appears in media library
  - Audio is captured when microphone selected
  - Recording works without microphone (video only)
  - Camera permission denied shows helpful error
  - Microphone permission denied shows helpful error
  - Device unavailable errors handled gracefully
  - Cannot start recording while another active
  - Screen recording with microphone selection works
  - System audio + microphone mixing works (if implemented)
  - Multiple recordings create separate files
  - File format is correct and playable

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master Bob |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
TBD

### Debug Log References
*To be populated during implementation*

### Completion Notes List
*To be populated after implementation*

### File List
*To be populated after implementation*

## QA Results
*Results from QA Agent review will be populated here*

