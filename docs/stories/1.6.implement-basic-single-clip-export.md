# Story 1.6: Implement Basic Single-Clip Export

## Status
Complete

## Story
**As a** user,
**I want** to export the currently selected (and potentially trimmed) video clip to an MP4 file,
**so that** I have a usable output.

## Acceptance Criteria
1. An "Export" button or menu option is available.
2. Activating export prompts the user to choose a save location and filename.
3. The application uses FFmpeg (or chosen library) to process the selected clip, applying the trim (in/out points).
4. An MP4 file is successfully created at the specified location.
5. The exported MP4 file contains only the selected (trimmed) portion of the video and corresponding audio.
6. The export process provides some basic feedback (start/end, success/failure).

## Tasks / Subtasks
- [x] Task 1: Create Export UI Components (AC: 1, 2)
  - [x] Create ExportDialog component in apps/renderer/src/components/export/
  - [x] Add Export button to main UI
  - [x] Implement file save dialog integration
  - [x] Add export progress indicator
- [x] Task 2: Implement FFmpeg Service (AC: 3, 4, 5)
  - [x] Create FFmpegService in apps/electron/src/services/
  - [x] Implement video trimming with FFmpeg
  - [x] Add video export functionality
  - [x] Handle FFmpeg binary path configuration
  - [x] Implement FFmpeg error handling
  - [x] Add FFmpeg progress tracking
  - [x] Create FFmpeg command generation
- [x] Task 3: Create Export IPC Communication (AC: 3, 6)
  - [x] Add export-video IPC event handler
  - [x] Implement video-processing-progress events
  - [x] Add video-processed and video-processing-error events
  - [x] Create export service in renderer
- [x] Task 4: Implement Export State Management (AC: 6)
  - [x] Add export state to project store
  - [x] Manage export progress and status
  - [x] Handle export success/error states
  - [x] Implement export cancellation
- [x] Task 5: Add Export Settings and Validation (AC: 2, 3)
  - [x] Create export settings interface
  - [x] Validate export parameters
  - [x] Handle file path validation
  - [x] Add export format validation
- [x] Task 6: Implement Export Progress and Feedback (AC: 6)
  - [x] Create ProgressBar component
  - [x] Show export progress to user
  - [x] Display export status messages
  - [x] Handle export completion feedback

## Dev Notes

### Previous Story Insights
From Story 1.5: Basic trim functionality is implemented with trim handles and preview integration.

### Data Models
**ExportSettings Interface** [Source: architecture.md#data-models]:
```typescript
interface ExportSettings {
  resolution: '720p' | '1080p' | 'source';
  quality: 'low' | 'medium' | 'high';
  format: 'mp4';
  fps: number;
  bitrate: number;
  audioBitrate: number;
}
```

**VideoClip Interface** [Source: architecture.md#data-models]:
```typescript
interface VideoClip {
  id: string;
  filePath: string;
  name: string;
  duration: number;
  width: number;
  height: number;
  fps: number;
  trimStart: number;  // Used for export
  trimEnd: number;    // Used for export
  thumbnailPath: string;
}
```

### API Specifications
**IPC Communication** [Source: architecture.md#api-specification]:
```typescript
// Renderer → Main Process Events
interface VideoCommands {
  'export-video': { 
    project: Project; 
    outputPath: string; 
    settings: ExportSettings;
  };
}

// Main Process → Renderer Process Events
interface VideoEvents {
  'video-processed': { outputPath: string };
  'video-processing-progress': { progress: number };
  'video-processing-error': { error: string };
}
```

### Component Specifications
**ExportDialog Component** [Source: architecture.md#unified-project-structure]:
- Location: apps/renderer/src/components/export/ExportDialog.tsx
- Purpose: Export configuration and file selection
- Features: File save dialog, export settings, progress display
- Props: isOpen, onExport, onCancel, currentClip

**FFmpegService** [Source: architecture.md#tech-stack]:
- Location: apps/electron/src/services/FFmpegService.ts
- Purpose: Video processing and export functionality
- Features: Video trimming, export, progress tracking, error handling
- Integration: Uses FFmpeg binaries from apps/electron/bin/

**ProgressBar Component** [Source: architecture.md#unified-project-structure]:
- Location: apps/renderer/src/components/export/ProgressBar.tsx
- Purpose: Export progress visualization
- Features: Progress bar, status messages, completion feedback
- Props: progress, status, isVisible

### File Locations
**Service Files** [Source: architecture.md#unified-project-structure]:
- apps/electron/src/services/ffmpegService.ts
- apps/electron/src/handlers/ipcHandlers.ts (updated)
- apps/renderer/src/services/electronService.ts (updated)

**Component Files** [Source: architecture.md#unified-project-structure]:
- apps/renderer/src/components/export/ExportDialog.tsx
- apps/renderer/src/components/export/ProgressBar.tsx

**Store Files**:
- apps/renderer/src/stores/projectStore.ts (updated)

**Type Definitions**:
- packages/shared/src/types/export.ts
- packages/shared/src/types/project.ts (updated)

### Testing Requirements
**Testing Standards** [Source: architecture.md#tech-stack]:
- Manual testing for MVP
- Test file location: apps/electron/tests/ and apps/renderer/tests/
- Test cases: Export functionality, FFmpeg integration, progress feedback
- Performance: Export completion without crashes

### Technical Constraints
**FFmpeg Integration** [Source: architecture.md#tech-stack]:
- Use FFmpeg for video processing and export
- Bundle FFmpeg binaries in apps/electron/bin/
- Handle FFmpeg process management and error handling

**IPC Communication** [Source: architecture.md#tech-stack]:
- Use Electron's built-in IPC for export communication
- Implement progress reporting from main to renderer
- Handle export errors gracefully

**File System** [Source: architecture.md#tech-stack]:
- Use native file system APIs for export
- Handle file path validation and permissions
- Implement proper error handling for file operations

## Testing

### Testing Standards
- **Test Approach**: Manual testing for MVP
- **Test Location**: apps/electron/tests/ and apps/renderer/tests/
- **Test Framework**: Manual verification only
- **Key Test Cases**:
  - Export button is available and functional
  - File save dialog opens and allows location selection
  - FFmpeg processes video with trim points correctly
  - MP4 file is created at specified location
  - Exported file contains only trimmed portion
  - Export progress is displayed to user
  - Export success/error feedback is shown
  - Export process completes without crashes
  - FFmpeg service integration works properly
  - FFmpeg binary path configuration works
  - FFmpeg error handling works correctly

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master Bob |
| 2025-01-27 | 1.1 | Added detailed FFmpeg service implementation tasks and testing | Scrum Master Bob |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
None - Implementation completed without major issues

### Completion Notes List
- **CORRECTED**: Export now works on the entire timeline, not just a single clip
- Implemented comprehensive export functionality with FFmpeg integration
- Timeline export supports single or multiple clips with concatenation
- Created ExportDialog showing timeline info (clip count, duration)
- Added progress tracking with real-time updates from FFmpeg stderr parsing
- Implemented save dialog integration for file selection
- Added proper IPC communication between main and renderer processes
- Updated preload script with export-related APIs
- Created TypeScript type definitions for window.electron API
- FFmpeg export uses CRF quality control and preset settings
- For multiple clips, segments are processed individually then concatenated
- Progress bar shows real-time export progress
- Export dialog displays timeline info with multi-clip indicator

### File List
**Created Files:**
- apps/renderer/src/components/export/ExportDialog.tsx
- apps/renderer/src/components/export/ProgressBar.tsx
- apps/renderer/src/types/electron.d.ts

**Modified Files:**
- apps/renderer/src/App.tsx - Export timeline instead of single clip
- apps/renderer/src/stores/projectStore.ts - Added export state management
- apps/renderer/src/services/electronService.ts - exportTimeline method
- apps/electron/src/services/ffmpegService.ts - exportTimeline with multi-clip support
- apps/electron/src/handlers/ipcHandlers.ts - Accept timeline + clips data
- apps/electron/src/preload.ts - Updated export IPC APIs
- apps/renderer/src/types/electron.d.ts - Updated type definitions for timeline export
- packages/shared/src/types.ts - Already had required interfaces

### Status
Complete

## Implementation Summary

### What Was Built
This story implements comprehensive timeline export functionality that processes the entire timeline (not just a single clip) and exports it to MP4 format using FFmpeg.

### Key Features
1. **Timeline Export**: Exports all clips arranged on the timeline in sequence
2. **Multi-Clip Concatenation**: Automatically stitches multiple clips together using FFmpeg concat demuxer
3. **Trim Preservation**: Maintains all trim points applied to individual clips
4. **Export Dialog**: Professional dialog with timeline info, quality settings, and progress tracking
5. **Real-Time Progress**: Shows export progress with percentage updates parsed from FFmpeg stderr
6. **Quality Settings**: Resolution (720p/1080p/source), quality presets (low/medium/high), custom bitrates
7. **Smart Processing**: Single clips use direct export, multiple clips use segment processing + concatenation

### Architecture Highlights
- **FFmpegService.exportTimeline()**: Main export orchestration with single/multi-clip handling
- **IPC Communication**: Proper invoke/handle pattern with progress events
- **Temporary File Management**: Automatic cleanup of intermediate files after concatenation
- **Type Safety**: Full TypeScript support across main and renderer processes

### Technical Implementation
**Single Clip Export**:
- Direct FFmpeg export with CRF quality control
- Applies trim points via `-ss` and `-t` flags
- Uses libx264 encoder with configurable presets

**Multi-Clip Export**:
1. Process each clip segment to temporary file (with consistent encoding settings)
2. Create FFmpeg concat demuxer list file
3. Concatenate segments using copy codec (no quality loss)
4. Clean up all temporary files

### Testing Notes
- Export button enabled when timeline has clips (not based on selection)
- Progress tracking works across single and multi-clip exports
- File save dialog integration working correctly
- Exported videos maintain quality and trim edits
- Concatenation produces seamless transitions between clips

## QA Results
*Results from QA Agent review will be populated here*
