# Story 1.6: Implement Basic Single-Clip Export

## Status
Draft

## Story
**As a** user,
**I want** to export the currently selected (and potentially trimmed) video clip to an MP4 file,
**so that** I have a usable output.

## Acceptance Criteria
1. An "Export" button or menu option is available.
2. Activating export prompts the user to choose a save location and filename.
3. The application uses FFmpeg (or chosen library) to process the selected clip, applying the trim (in/out points).
4. An MP4 file is successfully created at the specified location.
5. The exported MP4 file contains only the selected (trimmed) portion of the video and corresponding audio.
6. The export process provides some basic feedback (start/end, success/failure).

## Tasks / Subtasks
- [ ] Task 1: Create Export UI Components (AC: 1, 2)
  - [ ] Create ExportDialog component in apps/renderer/src/components/export/
  - [ ] Add Export button to main UI
  - [ ] Implement file save dialog integration
  - [ ] Add export progress indicator
- [ ] Task 2: Implement FFmpeg Service (AC: 3, 4, 5)
  - [ ] Create FFmpegService in apps/electron/src/services/
  - [ ] Implement video trimming with FFmpeg
  - [ ] Add video export functionality
  - [ ] Handle FFmpeg binary path configuration
  - [ ] Implement FFmpeg error handling
  - [ ] Add FFmpeg progress tracking
  - [ ] Create FFmpeg command generation
- [ ] Task 3: Create Export IPC Communication (AC: 3, 6)
  - [ ] Add export-video IPC event handler
  - [ ] Implement video-processing-progress events
  - [ ] Add video-processed and video-processing-error events
  - [ ] Create export service in renderer
- [ ] Task 4: Implement Export State Management (AC: 6)
  - [ ] Add export state to project store
  - [ ] Manage export progress and status
  - [ ] Handle export success/error states
  - [ ] Implement export cancellation
- [ ] Task 5: Add Export Settings and Validation (AC: 2, 3)
  - [ ] Create export settings interface
  - [ ] Validate export parameters
  - [ ] Handle file path validation
  - [ ] Add export format validation
- [ ] Task 6: Implement Export Progress and Feedback (AC: 6)
  - [ ] Create ProgressBar component
  - [ ] Show export progress to user
  - [ ] Display export status messages
  - [ ] Handle export completion feedback

## Dev Notes

### Previous Story Insights
From Story 1.5: Basic trim functionality is implemented with trim handles and preview integration.

### Data Models
**ExportSettings Interface** [Source: architecture.md#data-models]:
```typescript
interface ExportSettings {
  resolution: '720p' | '1080p' | 'source';
  quality: 'low' | 'medium' | 'high';
  format: 'mp4';
  fps: number;
  bitrate: number;
  audioBitrate: number;
}
```

**VideoClip Interface** [Source: architecture.md#data-models]:
```typescript
interface VideoClip {
  id: string;
  filePath: string;
  name: string;
  duration: number;
  width: number;
  height: number;
  fps: number;
  trimStart: number;  // Used for export
  trimEnd: number;    // Used for export
  thumbnailPath: string;
}
```

### API Specifications
**IPC Communication** [Source: architecture.md#api-specification]:
```typescript
// Renderer → Main Process Events
interface VideoCommands {
  'export-video': { 
    project: Project; 
    outputPath: string; 
    settings: ExportSettings;
  };
}

// Main Process → Renderer Process Events
interface VideoEvents {
  'video-processed': { outputPath: string };
  'video-processing-progress': { progress: number };
  'video-processing-error': { error: string };
}
```

### Component Specifications
**ExportDialog Component** [Source: architecture.md#unified-project-structure]:
- Location: apps/renderer/src/components/export/ExportDialog.tsx
- Purpose: Export configuration and file selection
- Features: File save dialog, export settings, progress display
- Props: isOpen, onExport, onCancel, currentClip

**FFmpegService** [Source: architecture.md#tech-stack]:
- Location: apps/electron/src/services/FFmpegService.ts
- Purpose: Video processing and export functionality
- Features: Video trimming, export, progress tracking, error handling
- Integration: Uses FFmpeg binaries from apps/electron/bin/

**ProgressBar Component** [Source: architecture.md#unified-project-structure]:
- Location: apps/renderer/src/components/export/ProgressBar.tsx
- Purpose: Export progress visualization
- Features: Progress bar, status messages, completion feedback
- Props: progress, status, isVisible

### File Locations
**Service Files** [Source: architecture.md#unified-project-structure]:
- apps/electron/src/services/ffmpegService.ts
- apps/electron/src/handlers/ipcHandlers.ts (updated)
- apps/renderer/src/services/electronService.ts (updated)

**Component Files** [Source: architecture.md#unified-project-structure]:
- apps/renderer/src/components/export/ExportDialog.tsx
- apps/renderer/src/components/export/ProgressBar.tsx

**Store Files**:
- apps/renderer/src/stores/projectStore.ts (updated)

**Type Definitions**:
- packages/shared/src/types/export.ts
- packages/shared/src/types/project.ts (updated)

### Testing Requirements
**Testing Standards** [Source: architecture.md#tech-stack]:
- Manual testing for MVP
- Test file location: apps/electron/tests/ and apps/renderer/tests/
- Test cases: Export functionality, FFmpeg integration, progress feedback
- Performance: Export completion without crashes

### Technical Constraints
**FFmpeg Integration** [Source: architecture.md#tech-stack]:
- Use FFmpeg for video processing and export
- Bundle FFmpeg binaries in apps/electron/bin/
- Handle FFmpeg process management and error handling

**IPC Communication** [Source: architecture.md#tech-stack]:
- Use Electron's built-in IPC for export communication
- Implement progress reporting from main to renderer
- Handle export errors gracefully

**File System** [Source: architecture.md#tech-stack]:
- Use native file system APIs for export
- Handle file path validation and permissions
- Implement proper error handling for file operations

## Testing

### Testing Standards
- **Test Approach**: Manual testing for MVP
- **Test Location**: apps/electron/tests/ and apps/renderer/tests/
- **Test Framework**: Manual verification only
- **Key Test Cases**:
  - Export button is available and functional
  - File save dialog opens and allows location selection
  - FFmpeg processes video with trim points correctly
  - MP4 file is created at specified location
  - Exported file contains only trimmed portion
  - Export progress is displayed to user
  - Export success/error feedback is shown
  - Export process completes without crashes
  - FFmpeg service integration works properly
  - FFmpeg binary path configuration works
  - FFmpeg error handling works correctly

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master Bob |
| 2025-01-27 | 1.1 | Added detailed FFmpeg service implementation tasks and testing | Scrum Master Bob |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be populated here*
