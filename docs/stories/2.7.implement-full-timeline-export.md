# Story 2.7: Implement Full Timeline Export

## Status
Pending

## Story
**As a** user,
**I want** to export the entire sequence of clips arranged on the timeline, including cuts and overlays,
**into a single MP4 file**,
**so that** I can share my final video.

## Acceptance Criteria
1. The export function processes all clips on the timeline in their arranged sequence [FR26].
2. Trims, splits, and deletions applied on the timeline are reflected in the output [FR26].
3. Video from multiple tracks is correctly composited in the output [FR19, FR26].
4. Users can select the export resolution (720p, 1080p, source) [FR27].
5. A progress indicator is shown during export [FR28].
6. The final MP4 is saved to the user's chosen location [FR29].

## Tasks / Subtasks
- [ ] Task 1: Extend Export Dialog for Full Timeline (AC: 4, 6)
  - [ ] Update ExportDialog to support full timeline export (not just single clip)
  - [ ] Add resolution selection dropdown (720p, 1080p, source)
  - [ ] Show timeline duration and clip count in dialog
  - [ ] Display export settings summary (resolution, quality)
  - [ ] Handle save location selection via file picker
  - [ ] Validate export settings before starting
  - [ ] Show estimated file size (optional)
  - [ ] Handle export cancellation
- [ ] Task 2: Enhance FFmpegService for Multi-Track Export (AC: 1, 2, 3)
  - [ ] Extend exportTimeline() to handle multiple video tracks
  - [ ] Process clips from all tracks (not just first track)
  - [ ] Calculate timeline duration from all tracks
  - [ ] Handle gaps in timeline (empty sections)
  - [ ] Process clips with trim points (trimStart, trimEnd)
  - [ ] Handle split clips (multiple TimelineClips referencing same VideoClip)
  - [ ] Handle deleted clips (skip missing clips gracefully)
  - [ ] Sort clips by track and timeline position
- [ ] Task 3: Implement FFmpeg Multi-Track Composition (AC: 3)
  - [ ] Use FFmpeg overlay filter for multi-track compositing
  - [ ] Render base track (Track 0) as bottom layer
  - [ ] Render overlay tracks as top layers in order
  - [ ] Handle track ordering (higher index = top layer)
  - [ ] Process overlapping clips at same timeline position
  - [ ] Handle clips that span across gaps
  - [ ] Use FFmpeg complex filter graph for multi-track composition
  - [ ] Optimize filter graph for performance
- [ ] Task 4: Process Timeline Sequence with Trims (AC: 2)
  - [ ] Extract correct video segments using trimStart/trimEnd
  - [ ] Apply trim points when processing each clip segment
  - [ ] Handle edge cases (trim points at clip boundaries)
  - [ ] Ensure trim accuracy (no frame loss)
  - [ ] Handle split clips correctly (each split segment uses different trim range)
  - [ ] Process clips in chronological order
- [ ] Task 5: Handle Timeline Gaps and Empty Sections (AC: 1, 2)
  - [ ] Detect gaps in timeline (no clips at certain times)
  - [ ] Handle gaps by using black frames or previous frame
  - [ ] Calculate timeline duration including gaps
  - [ ] Generate blank video segments for gaps
  - [ ] Ensure smooth transitions across gaps
  - [ ] Optionally show gap warnings in export dialog
- [ ] Task 6: Implement Resolution Scaling (AC: 4)
  - [ ] Detect source resolution from clips
  - [ ] Scale to 720p (1280x720) if selected
  - [ ] Scale to 1080p (1920x1080) if selected
  - [ ] Preserve source resolution if "source" selected
  - [ ] Handle mixed resolutions (scale all to target)
  - [ ] Maintain aspect ratio during scaling
  - [ ] Handle portrait vs landscape clips
  - [ ] Apply scaling to base track and overlays
- [ ] Task 7: Enhance Progress Indicator (AC: 5)
  - [ ] Update existing progress callback to show percentage
  - [ ] Calculate progress stages: processing clips, compositing, finalizing
  - [ ] Show detailed progress messages (e.g., "Processing clip 3/10")
  - [ ] Update progress bar UI component
  - [ ] Show time remaining estimate (optional)
  - [ ] Handle progress for multi-stage export
  - [ ] Update ExportDialog with progress display
  - [ ] Show cancel button during export (optional)
- [ ] Task 8: Optimize FFmpeg Export Performance (AC: 1, 2, 3)
  - [ ] Use efficient FFmpeg encoding settings
  - [ ] Optimize filter graph for multi-track
  - [ ] Use hardware acceleration if available (optional)
  - [ ] Process clips in batches if needed
  - [ ] Minimize temporary file I/O
  - [ ] Clean up temporary files after export
  - [ ] Handle large timeline exports (>1 hour)
  - [ ] Monitor memory usage during export
- [ ] Task 9: Validate Timeline Before Export (AC: 1, 2, 3)
  - [ ] Check that timeline has at least one clip
  - [ ] Validate all clip references exist
  - [ ] Check that source video files exist
  - [ ] Validate trim points are within clip bounds
  - [ ] Check for invalid track configurations
  - [ ] Show validation errors clearly
  - [ ] Prevent export if validation fails
- [ ] Task 10: Update Export Settings Structure (AC: 4)
  - [ ] Ensure ExportSettings supports resolution selection
  - [ ] Add resolution field if not present: '720p' | '1080p' | 'source'
  - [ ] Update ExportDialog to use resolution setting
  - [ ] Store default export resolution in preferences (optional)
  - [ ] Apply resolution to export process
- [ ] Task 11: Handle Export Errors Gracefully (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Catch FFmpeg errors and show user-friendly messages
  - [ ] Handle file permission errors
  - [ ] Handle disk space errors
  - [ ] Handle missing source file errors
  - [ ] Clean up partial exports on error
  - [ ] Show specific error messages for common failures
  - [ ] Log export errors for debugging
  - [ ] Allow retry after error
- [ ] Task 12: Test Export with All Timeline Features (AC: 1, 2, 3)
  - [ ] Test export with single clip
  - [ ] Test export with multiple clips on same track
  - [ ] Test export with trimmed clips
  - [ ] Test export with split clips
  - [ ] Test export with deleted clips (gaps)
  - [ ] Test export with multiple tracks (overlays)
  - [ ] Test export with overlapping clips on different tracks
  - [ ] Test export with different resolutions
  - [ ] Test export with empty timeline (should show error)

## Dev Notes

### Previous Story Insights
From Story 1.6: Basic single-clip export exists. FFmpegService.exportTimeline() handles single-track export with concatenation. Export dialog and progress indicator exist. Resolution scaling exists for single clips.

From Story 2.1: Multiple clips can be arranged on timeline sequentially. Timeline tracks contain TimelineClip instances with trimStart/trimEnd.

From Story 2.2: Split clips create multiple TimelineClip instances from same VideoClip. Delete operations remove clips from timeline. Clips maintain trim points after split.

From Story 2.3: Multiple tracks exist. Track order determines layering (tracks[0] = bottom, tracks[n] = top). Clips on different tracks can overlap in time.

**Current State**: FFmpegService.exportTimeline() handles single track export only. Need to extend for multi-track composition using FFmpeg overlay filters.

### Data Models
**Export Settings** [Source: architecture.md#data-models]:
```typescript
interface ExportSettings {
  resolution: '720p' | '1080p' | 'source';
  quality: 'low' | 'medium' | 'high';
  format: 'mp4';
  fps: number;
  bitrate: number;
  audioBitrate: number;
}
```

**Timeline Export Configuration**:
```typescript
interface TimelineExportConfig {
  timeline: Timeline;
  clips: VideoClip[];
  settings: ExportSettings;
  outputPath: string;
  includeAllTracks: boolean; // Export all tracks or just first
  handleGaps: 'black' | 'previous-frame' | 'error'; // How to handle gaps
}
```

### API Specifications
**IPC Commands** [Source: architecture.md#api-specification]:
```typescript
// Existing command (may need enhancement)
'export-video': {
  timeline: Timeline;
  clips: VideoClip[];
  outputPath: string;
  settings: ExportSettings;
} => Promise<void>;

// Events (existing)
'video-processing-progress': { progress: number; message?: string };
'video-processed': { outputPath: string };
'video-processing-error': { error: string };
```

**FFmpegService Methods**:
```typescript
// Enhanced method
exportTimeline(
  timeline: Timeline,
  clips: VideoClip[],
  outputPath: string,
  settings: ExportSettings,
  onProgress?: (progress: number, message?: string) => void
): Promise<void>;

// New helper methods
private processMultiTrackComposition(...): Promise<void>;
private buildFFmpegFilterGraph(...): string;
private processTimelineSegment(...): Promise<void>;
```

### Component Specifications
**ExportDialog Component** [Source: Story 1.6]:
- Update to show timeline duration and clip count
- Add resolution selector (720p, 1080p, source)
- Show export settings summary
- Display estimated file size (optional)
- Show progress during export
- Handle export cancellation

**ProgressBar Component** [Source: Story 1.6]:
- Enhance to show detailed progress messages
- Show stage information (processing, compositing, finalizing)
- Display percentage and time remaining (optional)

### File Locations
**Modified Files**:
- `apps/electron/src/services/ffmpegService.ts` - Multi-track export implementation
- `apps/renderer/src/components/export/ExportDialog.tsx` - Resolution selection, timeline info
- `apps/renderer/src/components/export/ProgressBar.tsx` - Enhanced progress display
- `apps/electron/src/handlers/ipcHandlers.ts` - Export handler updates (if needed)
- `packages/shared/src/types/video.ts` - ExportSettings updates (if needed)

**New Files**:
- None required - extending existing functionality

### Testing Requirements
**Testing Standards** [Source: architecture.md#tech-stack]:
- Manual testing for MVP
- Test file location: apps/electron/tests/
- Test cases: Single track export, multi-track export, trims, splits, deletions, resolutions
- Performance: Export should complete without crashes, handle large timelines

**Key Test Cases**:
- Export single clip on timeline - works correctly
- Export multiple clips on single track - sequences correctly
- Export with trimmed clips - trims applied correctly
- Export with split clips - split segments appear correctly
- Export with deleted clips - gaps handled correctly
- Export with 2 tracks (overlay) - composes correctly
- Export with overlapping clips - overlay works correctly
- Export at 720p resolution - scales correctly
- Export at 1080p resolution - scales correctly
- Export at source resolution - maintains original size
- Progress indicator shows during export
- Progress messages update correctly
- Export saves to selected location
- Export format is MP4 and playable
- Multi-track export maintains track ordering
- Overlay tracks appear on top of base track
- Gaps in timeline handled correctly (black frames or previous frame)
- Export with very long timeline (>1 hour) completes
- Export with multiple split clips works
- Export with clips on different tracks at different times works
- Missing source file shows error clearly
- Disk space error handled gracefully
- Export can be cancelled (if implemented)

### Technical Constraints
**FFmpeg Multi-Track Composition** [Source: architecture.md#tech-stack]:
- Use FFmpeg overlay filter: `overlay=x:y` for positioning overlays
- Use complex filter graph for multiple overlays
- Process tracks in order (bottom to top)
- Handle overlapping clips at same timeline position
- Maintain aspect ratios during composition
- Optimize filter graph for performance

**FFmpeg Filter Graph Example**:
```
[0:v][1:v]overlay=W-w-10:10[v]; [v][2:v]overlay=W-w-10:100[vout]
```
- Base track: [0:v]
- Overlay track 1: [1:v] at position (W-w-10, 10) - top-right
- Overlay track 2: [2:v] at position (W-w-10, 100) - below track 1
- Output: [vout]

**Trim and Split Handling** [Source: architecture.md#coding-standards]:
- Use `-ss startTime -t duration` for each clip segment
- Calculate duration from trimStart and trimEnd
- Process each TimelineClip independently
- Handle multiple TimelineClips from same VideoClip (split clips)
- Ensure frame-accurate trimming

**Resolution Scaling** [Source: architecture.md#coding-standards]:
- Use FFmpeg scale filter: `scale=1280:720` or `scale=1920:1080`
- Apply to base track, then overlays maintain relative positioning
- Preserve aspect ratio if source is not 16:9
- Handle mixed aspect ratios in timeline

**Timeline Gaps** [Source: architecture.md#coding-standards]:
- Generate black frames for gaps: `-f lavfi -i color=c=black:s=WxH:d=GAP_DURATION`
- Or use previous frame: use `-shortest` and let FFmpeg handle
- Default strategy: black frames for gaps
- Optional: Show gap warning in export dialog

**Performance Optimization** [Source: architecture.md#performance-optimization]:
- Use hardware acceleration if available (`-hwaccel`)
- Optimize encoding presets for multi-track
- Use efficient codec options
- Process in stages: trim clips → composite → finalize
- Clean up temporary files promptly
- Monitor memory usage for large exports

**Error Handling** [Source: architecture.md#coding-standards]:
- Validate timeline before export
- Check source files exist
- Handle FFmpeg errors gracefully
- Show user-friendly error messages
- Clean up on failure
- Allow retry after error

**Export Duration** [Source: architecture.md#coding-standards]:
- Export duration = max endTime of all clips on all tracks
- Include gaps in duration calculation
- Ensure timeline duration matches export duration
- Handle empty timeline (show error, don't export)

**File Format** [Source: architecture.md#tech-stack]:
- Output format: MP4 (H.264 video, AAC audio)
- Use `-movflags +faststart` for streaming
- Optimize for web playback
- Ensure compatibility with common players

**Audio Handling** [Source: architecture.md#coding-standards]:
- Extract audio from base track (Track 0)
- Mix audio from multiple tracks if needed (optional)
- Sync audio with composite video
- Handle clips without audio gracefully
- Use AAC codec for audio

## Testing

### Testing Standards
- **Test Approach**: Manual testing for MVP
- **Test Location**: apps/electron/tests/
- **Test Framework**: Manual verification only
- **Key Test Cases**:
  - Export single clip - works correctly
  - Export multiple sequential clips - sequences correctly
  - Export with trimmed clip - trim points applied
  - Export with split clip - both segments appear
  - Export with deleted clip - gap handled correctly
  - Export with 2 tracks overlapping - overlay works
  - Export at 720p - scales correctly
  - Export at 1080p - scales correctly
  - Export at source - maintains original size
  - Progress indicator shows during export
  - Export saves to selected location
  - Exported file is MP4 and playable
  - Multi-track composition order correct
  - Overlays positioned correctly
  - Gaps show as black frames
  - Long timeline exports complete
  - Missing source file shows error
  - Disk space error handled
  - Export validation works

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master Bob |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
TBD

### Debug Log References
*To be populated during implementation*

### Completion Notes List
*To be populated after implementation*

### File List
*To be populated after implementation*

## QA Results
*Results from QA Agent review will be populated here*

