# Story 2.6: Implement Simultaneous Screen + Webcam Recording

## Status
Pending

## Story
**As a** user,
**I want** to record my screen and webcam at the same time, with the webcam appearing as a Picture-in-Picture overlay,
**so that** I can create engaging tutorials or presentations.

## Acceptance Criteria
1. User can select both a screen/window source and a webcam source for simultaneous recording [FR9].
2. The recording captures both sources concurrently.
3. The resulting output places the webcam feed as a configurable PiP element over the screen recording (or saves as separate tracks for editing) [FR9].
4. Audio is captured correctly during simultaneous recording [FR10].
5. Recording can be stopped, saved, and added to the project [FR11, FR12].

## Tasks / Subtasks
- [ ] Task 1: Extend Recording Service for Simultaneous Recording (AC: 1, 2)
  - [ ] Add startSimultaneousRecording() method to RecordingService
  - [ ] Request screen capture stream (getDisplayMedia or desktopCapturer)
  - [ ] Request webcam video stream (getUserMedia)
  - [ ] Request microphone audio stream (getUserMedia) if needed
  - [ ] Handle concurrent stream capture
  - [ ] Manage multiple MediaStream instances simultaneously
  - [ ] Combine streams for recording (composited or separate tracks)
  - [ ] Handle stream synchronization
  - [ ] Error handling for concurrent stream failures
- [ ] Task 2: Implement Canvas-Based Real-Time Composition (AC: 2, 3)
  - [ ] Create RecordingCompositor utility class
  - [ ] Use HTML5 Canvas for real-time video composition
  - [ ] Draw screen video as base layer (full canvas size)
  - [ ] Draw webcam video as PiP overlay (scaled and positioned)
  - [ ] Configure PiP position (corners: top-left, top-right, bottom-left, bottom-right)
  - [ ] Configure PiP size (small, medium, large, or custom)
  - [ ] Handle aspect ratio preservation for webcam
  - [ ] Capture composed canvas to MediaRecorder
  - [ ] Maintain 30fps target during composition
- [ ] Task 3: Implement Dual Recording Mode Selection (AC: 3)
  - [ ] Add recording mode option: "Composited" vs "Separate Tracks"
  - [ ] Composited mode: Save as single video with PiP overlay
  - [ ] Separate tracks mode: Save screen and webcam as separate files
  - [ ] Update RecordingDialog with mode selection
  - [ ] Handle both recording modes in RecordingService
  - [ ] Document trade-offs (composited: ready-to-use but less flexible, separate: editable but requires composition later)
- [ ] Task 4: Implement PiP Configuration UI (AC: 3)
  - [ ] Add PiP position selector (4 corners)
  - [ ] Add PiP size selector (Small, Medium, Large, Custom)
  - [ ] Show live preview of PiP positioning
  - [ ] Allow drag-to-position PiP in preview (optional enhancement)
  - [ ] Display webcam feed preview in PiP preview area
  - [ ] Show screen preview as base layer
  - [ ] Update preview in real-time when settings change
- [ ] Task 5: Update Recording Dialog for Dual Source (AC: 1)
  - [ ] Extend RecordingDialog to support dual source selection
  - [ ] Add screen/window source selection (from Story 2.4)
  - [ ] Add webcam device selection (from Story 2.5)
  - [ ] Add microphone selection (from Story 2.5)
  - [ ] Add PiP configuration section
  - [ ] Add recording mode selection (Composited/Separate)
  - [ ] Show combined preview with PiP overlay
  - [ ] Display both screen and webcam previews simultaneously
- [ ] Task 6: Implement Audio Mixing for Simultaneous Recording (AC: 4)
  - [ ] Handle system audio from screen capture (if available)
  - [ ] Handle microphone audio (if selected)
  - [ ] Mix system audio + microphone audio (or let user choose)
  - [ ] Audio sync with composite video
  - [ ] Handle audio-only scenarios (no system audio, microphone only)
  - [ ] Volume balancing for mixed audio (optional)
  - [ ] Fallback if system audio unavailable
- [ ] Task 7: Implement Canvas-to-MediaRecorder Pipeline (AC: 2, 3)
  - [ ] Create MediaStream from Canvas using captureStream()
  - [ ] Combine canvas video stream with audio stream(s)
  - [ ] Configure MediaRecorder for composite stream
  - [ ] Handle video codec selection for composition
  - [ ] Optimize canvas rendering for recording
  - [ ] Ensure frame rate consistency
  - [ ] Handle recording chunks from canvas stream
  - [ ] Test performance with canvas recording
- [ ] Task 8: Implement Separate Tracks Recording Mode (AC: 3)
  - [ ] Record screen stream to separate file
  - [ ] Record webcam stream to separate file
  - [ ] Record audio stream to separate file (or mix with screen)
  - [ ] Generate unique filenames for each track
  - [ ] Synchronize start times for separate recordings
  - [ ] Handle stop for both recordings simultaneously
  - [ ] Import both files to media library
  - [ ] Optionally add both to timeline on separate tracks
- [ ] Task 9: Handle Recording Performance and Optimization (AC: 2)
  - [ ] Optimize canvas rendering for real-time composition
  - [ ] Limit canvas resolution if needed for performance
  - [ ] Use requestAnimationFrame for smooth composition
  - [ ] Monitor CPU usage during recording
  - [ ] Handle frame drops gracefully
  - [ ] Optimize MediaRecorder settings for performance
  - [ ] Test on lower-end systems
  - [ ] Add performance warnings if needed
- [ ] Task 10: Update IPC Handlers for Simultaneous Recording (AC: 1, 2, 5)
  - [ ] Add 'start-simultaneous-recording' IPC handler
  - [ ] Accept screen source, webcam device, microphone device, PiP config
  - [ ] Accept recording mode (composited vs separate)
  - [ ] Reuse 'stop-recording' handler (may need enhancement for separate tracks)
  - [ ] Update recording events to handle dual-source mode
  - [ ] Update preload.ts with simultaneous recording API
  - [ ] Update electron.d.ts with simultaneous recording types
- [ ] Task 11: Auto-Import Recorded Files (AC: 5)
  - [ ] For composited mode: Import single file (reuse Story 2.4 logic)
  - [ ] For separate tracks mode: Import both screen and webcam files
  - [ ] Generate thumbnails for imported files
  - [ ] Add to media library
  - [ ] Optionally add to timeline:
    - Composited mode: Single clip on Track 1
    - Separate tracks mode: Screen on Track 1, webcam on Track 2
  - [ ] Show success notification with file count
  - [ ] Handle import errors for any file

## Dev Notes

### Previous Story Insights
From Story 2.4: Screen recording infrastructure exists. RecordingService handles screen capture with MediaRecorder. Screen source selection is implemented.

From Story 2.5: Webcam recording infrastructure exists. Device selection (webcam, microphone) is implemented. getUserMedia() integration exists.

From Story 2.3: Multi-track timeline exists. Separate tracks can be added to different timeline tracks. This supports "separate tracks" recording mode.

**Current State**: Both screen and webcam recording work independently. Need to combine them with real-time composition.

### Data Models
**Simultaneous Recording Configuration**:
```typescript
interface SimultaneousRecordingConfig {
  screenSource: {
    type: 'fullscreen' | 'window';
    windowId?: string;
  };
  webcamDeviceId: string;
  microphoneDeviceId?: string;
  audioConfig: {
    includeSystemAudio: boolean;
    includeMicrophone: boolean;
    mixAudio: boolean; // Mix system + mic, or choose one
  };
  pipConfig: {
    position: 'top-left' | 'top-right' | 'bottom-left' | 'bottom-right';
    size: 'small' | 'medium' | 'large' | 'custom';
    customWidth?: number;
    customHeight?: number;
    customX?: number;
    customY?: number;
  };
  recordingMode: 'composited' | 'separate-tracks';
}
```

**Recording State Extension**:
```typescript
interface RecordingState {
  isRecording: boolean;
  recordingMode: 'screen' | 'webcam' | 'simultaneous';
  simultaneousConfig?: SimultaneousRecordingConfig;
  // ... other fields from Story 2.4/2.5
}
```

### API Specifications
**IPC Commands**:
```typescript
'start-simultaneous-recording': {
  screenSource: { type: 'fullscreen' | 'window'; windowId?: string };
  webcamDeviceId: string;
  microphoneDeviceId?: string;
  audioConfig: {
    includeSystemAudio: boolean;
    includeMicrophone: boolean;
    mixAudio: boolean;
  };
  pipConfig: {
    position: 'top-left' | 'top-right' | 'bottom-left' | 'bottom-right';
    size: 'small' | 'medium' | 'large' | 'custom';
    customWidth?: number;
    customHeight?: number;
  };
  recordingMode: 'composited' | 'separate-tracks';
} => Promise<void>;

'stop-recording': () => Promise<{ 
  filePath?: string; // Composited mode
  screenFilePath?: string; // Separate tracks mode
  webcamFilePath?: string; // Separate tracks mode
}>;
```

**Electron Service API**:
```typescript
startSimultaneousRecording(config: SimultaneousRecordingConfig): Promise<void>;
stopRecording(): Promise<RecordingResult>;
```

### Component Specifications
**RecordingDialog Enhancement**:
- Extend existing RecordingDialog to support simultaneous mode
- Add dual source selection tabs/sections
- Screen source selector (reuse from Story 2.4)
- Webcam device selector (reuse from Story 2.5)
- Microphone selector (reuse from Story 2.5)
- PiP configuration controls
- Recording mode selector (Composited/Separate)
- Combined preview showing both sources
- Real-time PiP preview overlay

**RecordingCompositor Service**:
- Utility class for real-time video composition
- Canvas-based rendering pipeline
- PiP positioning and sizing logic
- Frame-by-frame composition
- Performance optimization
- Stream synchronization

**RecordingControls Enhancement**:
- Add "Record Screen + Webcam" option
- Show simultaneous recording status
- Display both source indicators
- Reuse existing recording timer/indicator

### File Locations
**New Files**:
- `apps/renderer/src/services/recordingCompositor.ts` - Real-time composition utility
- `apps/renderer/src/components/recording/PipConfig.tsx` - PiP configuration component (optional)

**Modified Files**:
- `apps/electron/src/services/recordingService.ts` - Add simultaneous recording methods
- `apps/electron/src/handlers/ipcHandlers.ts` - Add simultaneous recording handlers
- `apps/renderer/src/components/recording/RecordingDialog.tsx` - Add dual source selection
- `apps/renderer/src/components/recording/RecordingControls.tsx` - Add simultaneous mode option
- `apps/renderer/src/services/electronService.ts` - Add simultaneous recording methods
- `apps/renderer/src/types/electron.d.ts` - Add simultaneous recording types
- `apps/renderer/src/App.tsx` - Integrate simultaneous recording

### Testing Requirements
**Testing Standards** [Source: architecture.md#tech-stack]:
- Manual testing for MVP
- Test file location: apps/electron/tests/ and apps/renderer/tests/
- Test cases: Dual source selection, real-time composition, PiP positioning, audio mixing, recording modes
- Performance: Real-time composition must maintain 30fps, no UI freezing

**Key Test Cases**:
- Select screen + webcam sources for simultaneous recording
- Preview shows both screen and webcam feeds
- PiP overlay appears correctly in preview
- PiP position changes work in real-time preview
- PiP size changes work correctly
- Start composited recording - saves single file with PiP
- Start separate tracks recording - saves two files
- Composited recording maintains 30fps
- Audio is captured correctly (system + mic or choice)
- Audio sync is correct in final recording
- Stop recording saves file(s) correctly
- Composited file shows webcam in correct PiP position
- Separate tracks files can be imported to timeline
- Import adds files to correct tracks (screen Track 1, webcam Track 2)
- Recording doesn't cause performance issues
- Canvas composition doesn't cause frame drops
- Multiple simultaneous recordings create separate files
- Cannot start multiple recordings simultaneously
- Permission errors handled for both sources
- Device disconnection handled gracefully
- PiP positioning works in all 4 corners
- PiP sizes (small/medium/large) work correctly
- Custom PiP size works correctly
- Audio mixing works (system + microphone)
- Audio selection works (system only, mic only, both)
- Recording works without system audio
- Recording works without microphone
- File format is correct and playable

### Technical Constraints
**Canvas Composition Performance** [Source: architecture.md#performance-optimization]:
- Canvas rendering must not exceed frame budget (33ms per frame for 30fps)
- Optimize drawing operations (use hardware acceleration if available)
- Limit canvas resolution if performance degrades
- Monitor CPU/GPU usage during recording
- Test on lower-end systems

**MediaStream Synchronization** [Source: architecture.md#coding-standards]:
- Ensure screen and webcam streams start simultaneously
- Sync timestamps for accurate composition
- Handle stream timing differences
- Account for latency in composition pipeline

**Canvas Recording** [Source: architecture.md#tech-stack]:
- Use HTMLCanvasElement.captureStream() for canvas-to-stream
- Configure appropriate frame rate for captureStream
- Combine canvas video stream with audio stream
- Handle MediaRecorder with canvas stream
- Test codec support for canvas streams

**PiP Configuration** [Source: architecture.md#coding-standards]:
- Default PiP size: 25% of canvas width (medium)
- Default PiP position: bottom-right
- Maintain webcam aspect ratio in PiP
- Scale webcam to fit PiP size
- Handle edge cases (very small/large screens)

**Audio Mixing** [Source: architecture.md#coding-standards]:
- Prefer Web Audio API for mixing if needed
- Or use MediaRecorder with multiple audio tracks
- Handle volume levels for mixed audio
- Ensure audio sync with video
- Test on different platforms (audio mixing support varies)

**Separate Tracks Mode** [Source: architecture.md#coding-standards]:
- Start both recordings simultaneously (same timestamp)
- Use separate MediaRecorder instances
- Generate synchronized filenames
- Handle stop for both recordings
- Import both files with correct metadata
- Optionally add to timeline on separate tracks (from Story 2.3)

**File Management** [Source: Story 2.4]:
- Composited mode: `screen-webcam-YYYY-MM-DD-HHmmss.webm`
- Separate tracks: `screen-YYYY-MM-DD-HHmmss.webm`, `webcam-YYYY-MM-DD-HHmmss.webm`
- Save to `~/.clipforge/recordings/` directory
- Clean up failed recordings on error

**Error Handling** [Source: architecture.md#coding-standards]:
- Handle stream disconnection (screen or webcam)
- Handle permission denied for either source
- Handle device unavailable errors
- Handle canvas rendering errors
- Handle MediaRecorder errors
- Show user-friendly error messages
- Clean up all resources on error

**Platform Considerations** [Source: architecture.md#development-workflow]:
- macOS: May have different performance characteristics
- Windows: Test canvas performance
- Linux: Test device access
- System audio capture varies by platform

**Integration with Story 2.3**:
- Separate tracks mode can add clips to different tracks
- Screen recording goes to Track 1
- Webcam recording goes to Track 2
- Supports multi-track editing workflow

## Testing

### Testing Standards
- **Test Approach**: Manual testing for MVP
- **Test Location**: apps/electron/tests/ and apps/renderer/tests/
- **Test Framework**: Manual verification only
- **Key Test Cases**:
  - Select screen + webcam for simultaneous recording
  - Preview shows both sources correctly
  - PiP overlay appears in correct position
  - Change PiP position - preview updates
  - Change PiP size - preview updates
  - Start composited recording - saves single file
  - Composited file has webcam in PiP position
  - Start separate tracks recording - saves two files
  - Both files can be imported to timeline
  - Import adds screen to Track 1, webcam to Track 2
  - Audio is captured correctly (system, mic, or both)
  - Audio sync is correct in recording
  - Recording maintains smooth 30fps
  - Stop recording saves file(s) correctly
  - Recorded files are playable
  - Performance doesn't degrade during recording
  - Cannot start multiple recordings
  - Permission errors handled gracefully
  - Device disconnection handled gracefully
  - All PiP positions work correctly
  - All PiP sizes work correctly
  - Custom PiP size works correctly

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master Bob |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
TBD

### Debug Log References
*To be populated during implementation*

### Completion Notes List
*To be populated after implementation*

### File List
*To be populated after implementation*

## QA Results
*Results from QA Agent review will be populated here*

