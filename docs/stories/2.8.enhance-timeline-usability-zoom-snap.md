# Story 2.8: Enhance Timeline Usability (Zoom/Snap)

## Status
Pending

## Story
**As a** user,
**I want** to zoom in/out on the timeline and have clips snap to edges,
**so that** I can perform more precise edits efficiently.

## Acceptance Criteria
1. Controls (e.g., slider, buttons, shortcuts) allow zooming the timeline view horizontally [FR20].
2. When dragging clips, their edges automatically align (snap) with the edges of adjacent clips or the playhead [FR21].

## Tasks / Subtasks
- [ ] Task 1: Enhance Zoom Controls UI (AC: 1)
  - [ ] Add zoom slider/controls to Timeline component
  - [ ] Add zoom in/out buttons (or enhance existing)
  - [ ] Add keyboard shortcuts for zoom (e.g., +, -, 0 for reset)
  - [ ] Add zoom percentage display (optional)
  - [ ] Add zoom to fit timeline button (optional)
  - [ ] Position zoom controls in timeline header or toolbar
  - [ ] Make zoom controls accessible and intuitive
- [ ] Task 2: Implement Smooth Zoom Behavior (AC: 1)
  - [ ] Update zoom level calculations for smooth transitions
  - [ ] Ensure playhead remains visible during zoom
  - [ ] Optionally center zoom on playhead position
  - [ ] Handle zoom limits (min/max zoom levels)
  - [ ] Update clip rendering when zoom changes
  - [ ] Update ruler markers when zoom changes
  - [ ] Test zoom performance with many clips
- [ ] Task 3: Implement Horizontal Scroll for Zoomed Timeline (AC: 1)
  - [ ] Add horizontal scrollbar when timeline exceeds viewport
  - [ ] Update scroll position based on zoom level
  - [ ] Maintain scroll position relative to playhead (optional)
  - [ ] Enable mouse wheel scrolling horizontally (Shift + wheel)
  - [ ] Handle scroll position during zoom operations
  - [ ] Update clip visibility based on scroll position
- [ ] Task 4: Implement Snap-to-Grid Logic (AC: 2)
  - [ ] Calculate grid positions based on gridSize
  - [ ] Implement snap threshold (e.g., within 10 pixels or 0.1 seconds)
  - [ ] Snap clip startTime to nearest grid position
  - [ ] Snap clip endTime to nearest grid position (optional)
  - [ ] Enable/disable snap based on snapToGrid setting
  - [ ] Visual feedback during snap (highlight grid line)
  - [ ] Update snap behavior for different grid sizes
- [ ] Task 5: Implement Snap-to-Clip-Edge (AC: 2)
  - [ ] Detect adjacent clips during drag operation
  - [ ] Calculate snap positions (start/end of adjacent clips)
  - [ ] Snap to clip start edge when dragging near
  - [ ] Snap to clip end edge when dragging near
  - [ ] Snap to both edges if dragging near center (optional)
  - [ ] Handle snap across different tracks (optional enhancement)
  - [ ] Visual feedback showing snap target
- [ ] Task 6: Implement Snap-to-Playhead (AC: 2)
  - [ ] Detect when clip edge is near playhead position
  - [ ] Snap clip start or end to playhead
  - [ ] Show visual indicator when snapping to playhead
  - [ ] Handle playhead movement during drag (optional)
  - [ ] Ensure snap works for both start and end edges
- [ ] Task 7: Integrate Snap into Clip Drag Operations (AC: 2)
  - [ ] Update reorderClip to use snap logic
  - [ ] Apply snap when calculating new clip position
  - [ ] Show snap indicators during drag (visual feedback)
  - [ ] Determine snap priority (grid > clip edge > playhead)
  - [ ] Handle snap for both horizontal drag (reorder) and drop operations
  - [ ] Update snap calculations for zoom-aware positions
- [ ] Task 8: Add Snap Toggle and Grid Size Controls (AC: 2)
  - [ ] Add snap toggle button/checkbox in timeline toolbar
  - [ ] Add grid size selector (0.1s, 0.5s, 1s, 5s, custom)
  - [ ] Update snapToGrid state when toggle changes
  - [ ] Update gridSize state when selector changes
  - [ ] Show visual grid lines when snap enabled (optional)
  - [ ] Update ruler to show grid marks
  - [ ] Persist snap preferences (optional)
- [ ] Task 9: Implement Snap Visual Feedback (AC: 2)
  - [ ] Highlight grid lines when snap to grid is active
  - [ ] Show snap indicator line during clip drag
  - [ ] Highlight adjacent clip edge when snapping
  - [ ] Show playhead highlight when snapping to playhead
  - [ ] Use distinct colors/visuals for different snap types
  - [ ] Animate snap indicator for better visibility
- [ ] Task 10: Update Timeline Ruler for Zoom and Grid (AC: 1, 2)
  - [ ] Update TimelineRuler to show appropriate time markers based on zoom
  - [ ] Show grid lines on ruler when snap enabled
  - [ ] Adjust marker spacing based on zoom level
  - [ ] Show major/minor tick marks appropriately
  - [ ] Update ruler click-to-seek to account for zoom
  - [ ] Ensure ruler scales correctly with zoom

## Dev Notes

### Previous Story Insights
From Story 2.1: Clip drag and reorder functionality exists. TimelineClip components are draggable. TimelineStore manages clip positions with reorderClip action.

From Story 2.2: Clip reorder operations already have snap logic implemented in reorderClip (lines 371-470 in timelineStore.ts). Snap threshold is 0.5 seconds, and clips snap to adjacent clip edges.

From Story 2.3: Multi-track timeline exists. Snap should work per track (clips snap within their own track context).

**Current State**: Basic zoom functionality exists (zoomLevel, setZoomLevel, handleZoomIn, handleZoomOut in Timeline.tsx). Basic snap logic exists in reorderClip. Need to enhance UI controls and expand snap functionality.

### Data Models
**Timeline Zoom State** [Source: architecture.md#data-models]:
- Timeline.zoomLevel: number (1.0 = normal, >1 = zoomed in, <1 = zoomed out)
- Zoom level affects clip width and spacing visually
- Timeline duration remains constant, only view scale changes

**Timeline Snap State** [Source: architecture.md#data-models]:
- Timeline.snapToGrid: boolean (enable/disable snapping)
- Timeline.gridSize: number (grid spacing in seconds)
- Snap threshold: pixels or seconds (e.g., 0.1s or 10px)

**Snap Configuration**:
```typescript
interface SnapConfig {
  enabled: boolean;
  mode: 'grid' | 'clips' | 'playhead' | 'all';
  threshold: number; // seconds or pixels
  gridSize: number; // seconds
}
```

### API Specifications
**Timeline Store Actions** [Source: Story 2.1]:
```typescript
// Existing actions
setZoomLevel: (zoomLevel: number) => void;
setSnapToGrid: (snapToGrid: boolean) => void;
setGridSize: (gridSize: number) => void;
reorderClip: (clipId: string, newStartTime: number) => void; // Already has snap

// New helper functions
calculateSnapPosition: (position: number, options: SnapConfig) => number;
findSnapTargets: (position: number, clipId: string, trackId: string) => SnapTarget[];
```

**Snap Target Type**:
```typescript
interface SnapTarget {
  position: number;
  type: 'grid' | 'clip-start' | 'clip-end' | 'playhead';
  clipId?: string; // For clip edges
  visualHint: string; // For UI feedback
}
```

### Component Specifications
**Timeline Component** [Source: architecture.md#components]:
- Add zoom controls (slider, buttons) to timeline header
- Add snap toggle and grid size controls
- Handle zoom keyboard shortcuts
- Update clip rendering based on zoom level
- Integrate snap logic into drag operations
- Show snap visual feedback

**TimelineZoomControls Component** [Source: architecture.md#components]:
- Zoom in button
- Zoom out button
- Zoom reset button
- Zoom slider (0.05x to 20x)
- Zoom percentage display
- Keyboard shortcuts handling

**TimelineSnapControls Component** [Source: architecture.md#components]:
- Snap toggle button/checkbox
- Grid size selector/dropdown
- Visual indicators for snap state
- Optional: Grid lines preview

**TimelineClip Component** [Source: architecture.md#components]:
- Integrate snap logic into drag handlers
- Show snap indicators during drag
- Calculate snap positions during drag
- Apply snap when drag ends

**TimelineRuler Component** [Source: architecture.md#components]:
- Update tick marks based on zoom level
- Show grid lines when snap enabled
- Handle ruler click with zoom-aware calculations
- Display appropriate time markers (seconds, minutes)

### File Locations
**Modified Files**:
- `apps/renderer/src/components/timeline/Timeline.tsx` - Zoom controls, snap integration
- `apps/renderer/src/components/timeline/TimelineClip.tsx` - Snap during drag
- `apps/renderer/src/components/timeline/TimelineRuler.tsx` - Zoom-aware ruler, grid marks
- `apps/renderer/src/stores/timelineStore.ts` - Enhance snap logic, add helpers
- `apps/renderer/src/App.tsx` - Keyboard shortcuts for zoom

**New Files**:
- `apps/renderer/src/components/timeline/TimelineZoomControls.tsx` - Zoom control UI (optional)
- `apps/renderer/src/components/timeline/TimelineSnapControls.tsx` - Snap control UI (optional)

**Note**: Can integrate zoom/snap controls directly into Timeline.tsx if simpler.

### Testing Requirements
**Testing Standards** [Source: architecture.md#tech-stack]:
- Manual testing for MVP
- Test file location: apps/renderer/tests/
- Test cases: Zoom controls, snap behavior, keyboard shortcuts, visual feedback
- Performance: Zoom and snap should be instant, no lag

**Key Test Cases**:
- Click zoom in button - timeline zooms in correctly
- Click zoom out button - timeline zooms out correctly
- Use keyboard shortcuts (+ - 0) - zoom works correctly
- Use zoom slider - timeline scales smoothly
- Clips resize correctly when zooming
- Ruler updates correctly when zooming
- Playhead remains visible during zoom
- Drag clip with snap enabled - snaps to grid positions
- Drag clip with snap enabled - snaps to adjacent clip edges
- Drag clip with snap enabled - snaps to playhead
- Snap threshold works correctly (snaps when close, not when far)
- Toggle snap off - clips don't snap when dragging
- Change grid size - snap positions update correctly
- Visual snap indicators appear during drag
- Snap works on multiple tracks (each track independently)
- Ruler shows grid marks when snap enabled
- Ruler click-to-seek works correctly with zoom
- Horizontal scroll works when zoomed in
- Shift + mouse wheel scrolls timeline horizontally
- Zoom performance is good with 10+ clips
- Snap calculations are accurate (no drift)
- Snap works for both start and end edges
- Grid lines visible when snap enabled (optional)
- Keyboard shortcuts don't conflict with other operations

### Technical Constraints
**Zoom Implementation** [Source: architecture.md#coding-standards]:
- Zoom affects visual scale only, not timeline duration
- Clip positions (startTime/endTime) remain in time units, not pixels
- Convert between time and pixels accounting for zoom: `pixel = (time / duration) * (width / zoomLevel)`
- Zoom range: 0.05x (very zoomed out) to 20x (very zoomed in)
- Default zoom: 1x (normal view)

**Zoom Performance** [Source: architecture.md#performance-optimization]:
- Zoom operations should be instant (< 100ms)
- Clip rendering must update smoothly during zoom
- Use efficient calculations for clip positions
- Minimize recalculations during zoom

**Snap Algorithm** [Source: architecture.md#coding-standards]:
- Calculate snap candidates: grid, adjacent clip edges, playhead
- Find nearest snap target within threshold
- Apply snap with priority: grid (if enabled) > clip edges > playhead
- Snap threshold: 0.1 seconds or 10 pixels (configurable)
- Convert snap positions between time and pixels accounting for zoom

**Grid Size Options** [Source: architecture.md#coding-standards]:
- Default grid sizes: 0.1s, 0.5s, 1s, 2s, 5s
- Custom grid size allowed (user input)
- Grid positions: multiples of gridSize from timeline start (0)
- Grid extends to timeline duration

**Clip Edge Detection** [Source: architecture.md#coding-standards]:
- Find adjacent clips on same track
- Check clips before and after current position
- Calculate distance to clip.startTime and clip.endTime
- Consider clips on other tracks for cross-track snap (optional)

**Snap Visual Feedback** [Source: architecture.md#coding-standards]:
- Show snap indicator line (vertical line) at snap position
- Use distinct color for snap indicator (e.g., yellow or blue)
- Highlight target clip edge when snapping
- Animate snap indicator appearance
- Remove indicator when snap disengages

**Keyboard Shortcuts** [Source: architecture.md#coding-standards]:
- `+` or `=` key: Zoom in
- `-` key: Zoom out
- `0` key: Reset zoom to 1x
- `Shift + Mouse Wheel`: Horizontal scroll
- Ensure shortcuts don't conflict with text input
- Add keyboard shortcut indicator/tooltip (optional)

**Integration with Existing Snap** [Source: Story 2.2]:
- Current reorderClip has snap logic with 0.5s threshold
- Enhance existing snap to support multiple snap types
- Ensure backward compatibility with existing snap behavior
- Expand snap to work for all clip operations (not just reorder)

**Scroll Behavior** [Source: architecture.md#frontend-architecture]:
- Timeline container should scroll horizontally when zoomed
- Maintain scroll position relative to playhead (optional UX enhancement)
- Handle scroll during zoom operations
- Enable native scrollbar or custom scrollbar

**Ruler Updates** [Source: architecture.md#components]:
- Show time markers appropriate for zoom level
- At high zoom: show seconds or frames
- At low zoom: show minutes
- Update ruler click calculations for zoom
- Show grid marks aligned with gridSize

## Testing

### Testing Standards
- **Test Approach**: Manual testing for MVP
- **Test Location**: apps/renderer/tests/
- **Test Framework**: Manual verification only
- **Key Test Cases**:
  - Zoom in button zooms timeline correctly
  - Zoom out button zooms timeline correctly
  - Keyboard shortcuts work for zoom
  - Zoom slider updates zoom level smoothly
  - Clips resize correctly when zooming
  - Ruler updates with zoom
  - Playhead visible during zoom
  - Snap to grid works when enabled
  - Snap to clip edge works correctly
  - Snap to playhead works correctly
  - Snap threshold prevents unwanted snapping
  - Toggle snap off disables snapping
  - Grid size changes affect snap positions
  - Visual snap indicators appear during drag
  - Snap works per track
  - Ruler shows grid marks
  - Horizontal scroll works when zoomed
  - Shift + wheel scrolls horizontally
  - Performance good with many clips

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master Bob |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
TBD

### Debug Log References
*To be populated during implementation*

### Completion Notes List
*To be populated after implementation*

### File List
*To be populated after implementation*

## QA Results
*Results from QA Agent review will be populated here*

